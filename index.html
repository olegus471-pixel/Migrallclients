–≤ –∫–æ–¥–µ –Ω–∏–∂–µ —è–∑—ã–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä—É—Å—Å–∫–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –≤—Ç–æ—Ä–æ–π (–Ω–µ –ø–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π) –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (–Ω–æ –±–µ–∑ –∏–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –≥—É–≥–ª)



<!DOCTYPE html>

<html lang="ru">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>MigrAll CRM</title>

<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700&family=Manrope:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>

/* ============================================================

   DESIGN TOKENS ‚Äî LIGHT THEME

   ============================================================ */

:root {

  --bg:        #f0f2f7;

  --surface:   #ffffff;

  --s2:        #f7f8fb;

  --s3:        #eef0f6;

  --s4:        #e4e7f0;

  --border:    #e0e4ed;

  --border2:   #c8cedf;

  --t1:        #1a1d2e;

  --t2:        #4a5068;

  --t3:        #8b92aa;

  --t4:        #b8bdd0;

  --acc:       #3b6ff5;

  --acc-d:     #e8effe;

  --acc-hover: #2d5ee0;

  --gre:       #16a34a;

  --gre-d:     #dcfce7;

  --yel:       #d97706;

  --yel-d:     #fef3c7;

  --ora:       #ea580c;

  --ora-d:     #ffedd5;

  --red:       #dc2626;

  --red-d:     #fee2e2;

  --pur:       #7c3aed;

  --pur-d:     #ede9fe;

  --tea:       #0d9488;

  --tea-d:     #ccfbf1;

  --pnk:       #db2777;

  --pnk-d:     #fce7f3;

  --sh:        0 1px 3px rgba(0,0,0,.07), 0 1px 2px rgba(0,0,0,.04);

  --sh2:       0 4px 16px rgba(0,0,0,.10), 0 2px 6px rgba(0,0,0,.06);

  --sh3:       0 20px 60px rgba(0,0,0,.18);

  --r:         10px;

  --r2:        7px;

}

/* ============================================================

   RESET & BASE

   ============================================================ */

*{box-sizing:border-box;margin:0;padding:0}

html,body{height:100%;overflow:hidden}

body{font-family:'Manrope',sans-serif;background:var(--bg);color:var(--t1);font-size:14px;line-height:1.55}

a{color:var(--acc);text-decoration:none}

a:hover{text-decoration:underline}

::-webkit-scrollbar{width:4px;height:4px}

::-webkit-scrollbar-track{background:transparent}

::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}

::-webkit-scrollbar-thumb:hover{background:var(--t3)}

input,select,textarea{font-family:'Manrope',sans-serif}

/* ============================================================

   LAYOUT

   ============================================================ */

.app{display:flex;height:100vh;overflow:hidden}

/* ---- SIDEBAR ---- */

.sb{width:220px;min-width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:transform .25s,width .25s;z-index:100}

.sb-logo{padding:16px 16px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}

.sb-logo-icon{width:32px;height:32px;background:var(--acc);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}

.sb-logo-wrap{}

.sb-logo-t{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;color:var(--t1);line-height:1.1}

.sb-logo-s{font-size:8px;color:var(--t3);font-family:'IBM Plex Mono',monospace;margin-top:1px}

.sb-nav{flex:1;padding:6px 0;overflow-y:auto}

.sb-sec{padding:10px 14px 3px;font-size:8px;font-weight:700;letter-spacing:.12em;color:var(--t4);text-transform:uppercase;font-family:'IBM Plex Mono',monospace}

.ni{display:flex;align-items:center;gap:9px;padding:8px 14px;cursor:pointer;transition:all .12s;font-size:12.5px;font-weight:500;color:var(--t2);border-left:2px solid transparent;white-space:nowrap;border-radius:0 6px 6px 0;margin:0 6px 0 0;position:relative}

.ni:hover{background:var(--s2);color:var(--t1)}

.ni.active{background:var(--acc-d);color:var(--acc);border-left-color:var(--acc);font-weight:600}

.ni-ic{font-size:14px;width:16px;text-align:center;flex-shrink:0}

.ni-bdg{margin-left:auto;background:var(--red);color:#fff;font-size:8px;font-weight:700;padding:1px 5px;border-radius:8px;font-family:'IBM Plex Mono',monospace;min-width:18px;text-align:center}

.ni-bdg.y{background:var(--yel)}

.ni-bdg.g{background:var(--gre)}

.sb-bot{padding:10px 12px 12px;border-top:1px solid var(--border)}

.sync-btn{width:100%;padding:7px;background:var(--s2);border:1px solid var(--border);color:var(--t2);border-radius:var(--r2);cursor:pointer;font-size:10px;font-family:'Manrope',sans-serif;font-weight:600;transition:all .12s;display:flex;align-items:center;justify-content:center;gap:6px}

.sync-btn:hover{background:var(--acc-d);color:var(--acc);border-color:var(--acc)}

#sync-spin{display:inline-block;transition:transform .1s}

.api-status{margin-top:6px;font-size:9px;color:var(--t3);font-family:'IBM Plex Mono',monospace;display:flex;align-items:center;gap:4px}

.api-dot{width:5px;height:5px;border-radius:50%;background:var(--gre);flex-shrink:0}

.api-dot.err{background:var(--red)}.api-dot.warn{background:var(--yel)}

/* ---- TOPBAR ---- */

.topbar{padding:10px 18px;border-bottom:1px solid var(--border);background:var(--surface);display:flex;align-items:center;gap:10px;min-height:52px;flex-shrink:0}

.topbar-toggle{display:none;background:none;border:none;cursor:pointer;font-size:18px;color:var(--t2);padding:2px 4px;border-radius:4px}

.topbar-toggle:hover{background:var(--s2)}

.pg-title{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;white-space:nowrap;color:var(--t1)}

.tb-search{flex:1;max-width:280px;background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);padding:6px 11px;color:var(--t1);font-size:11px;outline:none;transition:border-color .14s}

.tb-search:focus{border-color:var(--acc);background:var(--surface)}

.tb-search::placeholder{color:var(--t3)}

.tb-right{margin-left:auto;display:flex;align-items:center;gap:8px}

.live-dot{width:7px;height:7px;border-radius:50%;background:var(--gre);animation:pulse 2s infinite}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.loading-bar{position:fixed;top:0;left:0;height:2px;background:var(--acc);width:0;z-index:9999;transition:width .3s}

/* ---- MAIN ---- */

.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

.content{flex:1;overflow-y:auto;padding:16px 18px}

.view{display:none}.view.active{display:block}

/* ============================================================

   COMPONENTS

   ============================================================ */

/* --- PANELS --- */

.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}

.dt-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%}

.ph{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--surface)}

.ph-title{font-size:10px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.08em;font-family:'IBM Plex Mono',monospace}

.ph-cnt{margin-left:auto;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t3)}

.ph-actions{margin-left:auto;display:flex;gap:5px;align-items:center}

/* --- GRID HELPERS --- */

.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}

.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px}

.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px}

/* --- BUTTONS --- */

.btn{padding:7px 14px;border-radius:var(--r2);font-size:12px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .12s;font-family:'Manrope',sans-serif;white-space:nowrap;display:inline-flex;align-items:center;gap:4px}

.btn-p{background:var(--acc);color:#fff;border-color:var(--acc)}.btn-p:hover{background:var(--acc-hover)}

.btn-g{background:var(--s2);color:var(--t2);border-color:var(--border)}.btn-g:hover{background:var(--s3);color:var(--t1)}

.btn-red{background:var(--red-d);color:var(--red);border-color:var(--red)}.btn-red:hover{opacity:.8}

.btn-sm{padding:3px 9px;font-size:10px}

.btn-xs{padding:2px 7px;font-size:9px}

/* --- CHIPS --- */

.chips{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px}

.chip{padding:5px 11px;border-radius:20px;font-size:10.5px;font-weight:600;cursor:pointer;transition:all .12s;border:1.5px solid var(--border);color:var(--t2);background:var(--surface);white-space:nowrap}

.chip:hover{border-color:var(--border2);color:var(--t1)}

.chip.active{border-color:var(--acc);color:var(--acc);background:var(--acc-d)}

/* --- SEC HEADER --- */

.sec-h{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap}

.sec-t{font-family:'Unbounded',sans-serif;font-size:15px;font-weight:700;color:var(--t1)}

.sec-a{margin-left:auto;display:flex;gap:6px;align-items:center}

/* --- BADGES --- */

.bdg{display:inline-flex;align-items:center;padding:2px 8px;border-radius:4px;font-size:9.5px;font-weight:700;white-space:nowrap;font-family:'IBM Plex Mono',monospace;letter-spacing:.03em}

.bdg.gre{background:var(--gre-d);color:var(--gre)}.bdg.blu{background:var(--acc-d);color:var(--acc)}

.bdg.yel{background:var(--yel-d);color:var(--yel)}.bdg.ora{background:var(--ora-d);color:var(--ora)}

.bdg.red{background:var(--red-d);color:var(--red)}.bdg.pur{background:var(--pur-d);color:var(--pur)}

.bdg.tea{background:var(--tea-d);color:var(--tea)}.bdg.pnk{background:var(--pnk-d);color:var(--pnk)}

.bdg.gry{background:var(--s3);color:var(--t3)}

/* --- TABLE --- */

.dt{width:100%;border-collapse:collapse}

.dt th{padding:9px 13px;text-align:left;font-size:9px;font-weight:700;color:var(--t3);border-bottom:1.5px solid var(--border);background:var(--s2);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;font-family:'IBM Plex Mono',monospace}

.dt td{padding:10px 13px;font-size:12.5px;border-bottom:1px solid var(--border);vertical-align:middle}

.dt tr:last-child td{border-bottom:none}

.dt tr:hover td{background:var(--s2);cursor:pointer}

.dt tr{transition:background .08s}

.dt td.mono{font-family:'IBM Plex Mono',monospace;font-size:10px}

.edit-btn{background:none;border:none;color:var(--t3);cursor:pointer;font-size:11px;padding:3px 5px;border-radius:4px;transition:all .12s}

.edit-btn:hover{background:var(--acc-d);color:var(--acc)}

/* ============================================================

   KPI CARDS

   ============================================================ */

.kpi-g{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px}

.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);position:relative;overflow:hidden}

.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}

.kpi.blu::before{background:var(--acc)}.kpi.gre::before{background:var(--gre)}

.kpi.yel::before{background:var(--yel)}.kpi.red::before{background:var(--red)}

.kpi-l{font-size:9px;color:var(--t3);font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px;font-family:'IBM Plex Mono',monospace}

.kpi-v{font-family:'Unbounded',sans-serif;font-size:32px;font-weight:700;line-height:1}

.kpi-s{font-size:9px;color:var(--t3);margin-top:4px}

.kpi.blu .kpi-v{color:var(--acc)}.kpi.gre .kpi-v{color:var(--gre)}.kpi.yel .kpi-v{color:var(--yel)}.kpi.red .kpi-v{color:var(--red)}

/* ============================================================

   DASHBOARD TASK STATS

   ============================================================ */

.ts-g{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}

.ts-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;box-shadow:var(--sh)}

.ts-l{font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--t3);margin-bottom:4px;font-family:'IBM Plex Mono',monospace}

.ts-v{font-family:'Unbounded',sans-serif;font-size:22px;font-weight:700;color:var(--t1)}

.ts-filter{display:flex;gap:4px;margin-bottom:10px}

.ts-fc{padding:3px 8px;border-radius:14px;font-size:9px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);color:var(--t2);background:var(--surface);transition:all .12s}

.ts-fc:hover{border-color:var(--border2)}.ts-fc.active{border-color:var(--acc);color:var(--acc);background:var(--acc-d)}

/* ============================================================

   STAT ROWS (status modules)

   ============================================================ */

.stat-row{display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);gap:8px;transition:background .08s}

.stat-row:last-child{border-bottom:none}

.stat-row:hover{background:var(--s2)}

.stat-num{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;color:var(--acc);min-width:38px;flex-shrink:0}

.stat-name{font-size:12.5px;font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.stat-date{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t3);white-space:nowrap;flex-shrink:0}

/* ============================================================

   KANBAN

   ============================================================ */

.kb-wrap{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;align-items:flex-start}

.kb-col{min-width:210px;max-width:210px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);display:flex;flex-direction:column;max-height:calc(100vh - 195px)}

.kb-hdr{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;flex-shrink:0}

.kb-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

.kb-lbl{font-size:10px;font-weight:700;flex:1;letter-spacing:.02em}

.kb-cnt{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t3)}

.kb-cards{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px}

.kcard{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:9px 10px;cursor:pointer;transition:all .12s}

.kcard:hover{border-color:var(--border2);box-shadow:var(--sh);background:var(--surface);transform:translateY(-1px)}

.kcard-id{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--t3);margin-bottom:2px}

.kcard-name{font-size:11px;font-weight:700;margin-bottom:4px;color:var(--t1)}

.kcard-svc{font-size:9px;font-weight:600;margin-bottom:3px}

.kcard-sub{font-size:8px;padding:2px 6px;border-radius:4px;background:var(--pur-d);color:var(--pur);font-family:'IBM Plex Mono',monospace;display:inline-block;margin-bottom:4px;font-weight:600}

.kcard-ft{display:flex;align-items:center;gap:4px;flex-wrap:wrap}

.kcard-tg{font-size:8.5px;color:var(--t3);font-family:'IBM Plex Mono',monospace;flex:1}

.kb-add{margin:4px 6px 6px;padding:6px;border:1.5px dashed var(--border2);border-radius:var(--r2);text-align:center;font-size:10px;color:var(--t3);cursor:pointer;transition:all .12s;flex-shrink:0}

.kb-add:hover{border-color:var(--acc);color:var(--acc);background:var(--acc-d)}

/* ============================================================

   PIPELINE STEPS

   ============================================================ */

.pipe-steps{display:flex;align-items:center;flex-wrap:wrap;gap:4px;padding:4px 0 10px}

.ps-b{padding:4px 8px;border-radius:14px;font-size:8px;font-weight:600;font-family:'IBM Plex Mono',monospace;white-space:nowrap;border:1.5px solid var(--border);color:var(--t3);background:var(--s2);cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:3px}

.ps-b:hover{border-color:var(--border2);color:var(--t1)}

.ps-b.active{background:var(--acc-d);color:var(--acc);border-color:var(--acc)}

.ps-b.done{background:var(--gre-d);color:var(--gre);border-color:var(--gre)}

.ps-b.done::before{content:'‚úì '}

.ps-arr{color:var(--t4);font-size:9px}

/* ============================================================

   TASKS

   ============================================================ */

.task-board{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

.tcol{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);display:flex;flex-direction:column;max-height:calc(100vh - 205px)}

.tcol-h{padding:10px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;flex-shrink:0}

.tcol-t{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;font-family:'IBM Plex Mono',monospace}

.tcol-cnt{margin-left:auto;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t3)}

.tlist{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px;min-height:60px}

.tcard{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:9px 10px;cursor:grab;transition:all .12s;user-select:none;border-left:3px solid transparent}

.tcard:hover{border-color:var(--border2);box-shadow:var(--sh);background:var(--surface)}

.tcard.dragging{opacity:.35;cursor:grabbing}

.tcard.drag-target{border-color:var(--acc)!important;background:var(--acc-d)!important}

.tcard.pb-high{border-left-color:var(--red)}.tcard.pb-mid{border-left-color:var(--yel)}.tcard.pb-low{border-left-color:var(--t4)}

.tcard-txt{font-size:11.5px;font-weight:500;margin-bottom:5px;line-height:1.4}

.tcard-meta{display:flex;align-items:center;gap:5px;font-size:8.5px;font-family:'IBM Plex Mono',monospace;flex-wrap:wrap;color:var(--t3)}

.tcard-meta .cn{color:var(--acc);font-weight:600}.tcard-meta .as{color:var(--tea);font-weight:600}

.tcard-acts{display:flex;gap:3px;margin-top:5px;flex-wrap:wrap}

.t-add{margin:4px 6px 6px;padding:6px;border:1.5px dashed var(--border2);border-radius:var(--r2);text-align:center;font-size:10px;color:var(--t3);cursor:pointer;transition:all .12s;flex-shrink:0}

.t-add:hover{border-color:var(--acc);color:var(--acc);background:var(--acc-d)}

.pdot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0}

.pdot.high{background:var(--red)}.pdot.mid{background:var(--yel)}.pdot.low{background:var(--t4)}

.tcol.drop-active{outline:2px dashed var(--acc);outline-offset:-3px;background:var(--acc-d)}

/* ============================================================

   SCHEDULE

   ============================================================ */

.sched-layout{display:grid;grid-template-columns:196px 1fr;gap:12px}

.sched-mini{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh)}

.sched-mnav{padding:9px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}

.sched-mnav-t{font-family:'Unbounded',sans-serif;font-size:10px;font-weight:700;flex:1;color:var(--t1)}

.sched-mb{background:none;border:none;color:var(--t2);cursor:pointer;font-size:13px;padding:2px 5px;border-radius:4px;transition:background .1s}

.sched-mb:hover{background:var(--s2);color:var(--t1)}

.sched-mg{display:grid;grid-template-columns:repeat(7,1fr);padding:6px 8px 2px}

.sched-dow{font-size:7px;font-weight:700;color:var(--t3);text-align:center;padding:2px 0;text-transform:uppercase;font-family:'IBM Plex Mono',monospace}

.sched-day{font-size:9.5px;text-align:center;padding:3px 1px;border-radius:4px;cursor:pointer;transition:all .1s;font-weight:500;color:var(--t2);min-width:0}

.sched-day:hover{background:var(--s2);color:var(--t1)}.sched-day.has{color:var(--acc);font-weight:700}.sched-day.sel{background:var(--acc);color:#fff}.sched-day.tod{border:1.5px solid var(--acc)}.sched-day.oth{color:var(--t4)}

.sched-slots{padding:8px 12px;border-top:1px solid var(--border)}

.sched-slots-t{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:5px;font-weight:700;font-family:'IBM Plex Mono',monospace}

.sched-sl{max-height:160px;overflow-y:auto}

.slot-item{padding:4px 7px;border-radius:4px;font-size:9px;font-family:'IBM Plex Mono',monospace;cursor:pointer;transition:background .1s;margin-bottom:2px;display:flex;align-items:center;gap:6px;border:1px solid transparent}

.slot-item:hover{background:var(--s2)}.slot-item.occ{color:var(--t3)}.slot-item.free{color:var(--gre)}.slot-item.free:hover{background:var(--gre-d)}

.slot-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}.slot-dot.free{background:var(--gre)}.slot-dot.occ{background:var(--t4)}

.meet-row{display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);gap:8px}

.meet-row:last-child{border-bottom:none}

.meet-t{font-family:'IBM Plex Mono',monospace;font-size:9.5px;color:var(--acc);min-width:100px;flex-shrink:0;font-weight:600}

.meet-n{font-size:11.5px;font-weight:600;flex:1}

.meet-lnk{font-size:9px;color:var(--acc);font-family:'IBM Plex Mono',monospace}

/* ============================================================

   CALENDAR

   ============================================================ */

.cal-layout{display:grid;grid-template-columns:1fr 230px;gap:12px}

.cal-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}

.cal-nav{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border)}

.cal-nav-btn{background:var(--s2);border:1px solid var(--border);color:var(--t2);padding:4px 10px;border-radius:var(--r2);cursor:pointer;font-size:12px;transition:all .12s}

.cal-nav-btn:hover{background:var(--s3);color:var(--t1)}

.cal-month{font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;flex:1;color:var(--t1)}

.cal-dows{display:grid;grid-template-columns:repeat(7,1fr)}

.cal-dow{padding:6px;font-size:8px;font-weight:700;color:var(--t3);border-bottom:1px solid var(--border);background:var(--s2);text-transform:uppercase;letter-spacing:.06em;text-align:center;font-family:'IBM Plex Mono',monospace}

.cal-grid{display:grid;grid-template-columns:repeat(7,1fr)}

.cal-cell{min-height:70px;padding:5px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);cursor:pointer;transition:background .08s}

.cal-cell:nth-child(7n){border-right:none}.cal-cell:hover{background:var(--s2)}

.cal-cell.today{background:var(--acc-d)}.cal-cell.selected{background:var(--s3)}

.cal-dn{font-size:10.5px;font-weight:600;margin-bottom:2px;color:var(--t1)}.cal-cell.om .cal-dn{color:var(--t4)}

.cal-ev{font-size:7px;padding:1px 3px;border-radius:2px;margin-bottom:1px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-family:'IBM Plex Mono',monospace;font-weight:600}

.cal-ev.meet{background:var(--gre-d);color:var(--gre)}.cal-ev.court{background:var(--pur-d);color:var(--pur)}.cal-ev.deadline{background:var(--red-d);color:var(--red)}

.cal-sb{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;display:flex;flex-direction:column;max-height:calc(100vh - 170px)}

.cal-sb-d{padding:10px 13px;border-bottom:1px solid var(--border);font-size:11.5px;font-weight:700}

.cal-sb-evts{flex:1;overflow-y:auto}

.cal-evitem{padding:9px 12px;border-bottom:1px solid var(--border)}

.cal-evitem:last-child{border-bottom:none}

.cal-evtime{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--acc);margin-bottom:2px;font-weight:600}

.cal-evname{font-size:11px;font-weight:600}

.cal-evmeta{font-size:9px;color:var(--t3)}

.cal-empty{padding:24px;text-align:center;color:var(--t3);font-size:10px}

/* ============================================================

   INTEGRATION CARDS

   ============================================================ */

.int-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}

.int-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);transition:box-shadow .12s}

.int-card:hover{box-shadow:var(--sh2)}

.int-ic{font-size:24px;margin-bottom:8px}

.int-nm{font-size:11.5px;font-weight:700;margin-bottom:2px;color:var(--t1)}

.int-id{font-family:'IBM Plex Mono',monospace;font-size:7.5px;color:var(--t3);margin-bottom:8px;word-break:break-all}

.int-sr{display:flex;align-items:center;gap:5px;font-size:9px;color:var(--t2)}

.int-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

.int-dot.ok{background:var(--gre)}.int-dot.w{background:var(--yel)}.int-dot.e{background:var(--red)}

.api-info{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-top:12px}

.api-info pre{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--t2);line-height:1.7;white-space:pre-wrap;word-break:break-word}

/* ============================================================

   ONBOARD CHECKLIST

   ============================================================ */

.ob-list{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:10px 12px}

.ob-item{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:11px;border-bottom:1px solid var(--border)}

.ob-item:last-child{border-bottom:none}

.ob-item input[type=checkbox]{accent-color:var(--acc);width:14px;height:14px;cursor:pointer}

.ob-item.done{color:var(--t3);text-decoration:line-through}

.ob-item label{cursor:pointer;flex:1}

/* ============================================================

   COMMENTS

   ============================================================ */

.cmt-list{display:flex;flex-direction:column;gap:6px;margin-bottom:8px;max-height:180px;overflow-y:auto}

.cmt{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:8px 10px}

.cmt-m{font-size:8.5px;color:var(--t3);font-family:'IBM Plex Mono',monospace;margin-bottom:3px;display:flex;gap:8px}

.cmt-m span{font-weight:700;color:var(--t2)}

.cmt-t{font-size:11px;color:var(--t1);line-height:1.5}

/* ============================================================

   MODAL

   ============================================================ */

.ov{position:fixed;inset:0;background:rgba(15,18,35,.45);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:16px}

.ov.open{display:flex}

.modal{background:var(--surface);border:1px solid var(--border);border-radius:13px;width:620px;max-width:100%;max-height:92vh;overflow-y:auto;padding:22px;box-shadow:var(--sh3);animation:mup .16s ease}

.modal.wide{width:780px}.modal.narrow{width:420px}

@keyframes mup{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.mhdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px}

.mcls{background:none;border:none;color:var(--t3);cursor:pointer;font-size:18px;padding:0 2px;line-height:1;transition:color .1s}

.mcls:hover{color:var(--red)}

.msec{margin-bottom:14px}

.msl{font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t3);margin-bottom:7px;font-family:'IBM Plex Mono',monospace}

.mrow{display:flex;gap:10px;margin-bottom:10px;align-items:flex-end}

.mf{flex:1;min-width:0}

.mfl{font-size:10.5px;color:var(--t2);margin-bottom:4px;font-weight:600;display:block}

.mi{width:100%;background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);padding:8px 12px;color:var(--t1);font-size:12.5px;font-family:'Manrope',sans-serif;outline:none;transition:border-color .12s}

.mi:focus{border-color:var(--acc);background:var(--surface)}

.ms{width:100%;background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);padding:8px 12px;color:var(--t1);font-size:12.5px;font-family:'Manrope',sans-serif;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238b92aa'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}

.ms:focus{border-color:var(--acc)}

.mta{width:100%;background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);padding:8px 11px;color:var(--t1);font-size:11.5px;font-family:'Manrope',sans-serif;outline:none;resize:vertical;min-height:72px;transition:border-color .12s}

.mta:focus{border-color:var(--acc)}

.mdiv{border:none;border-top:1px solid var(--border);margin:14px 0}

.mft{display:flex;gap:7px;justify-content:flex-end;margin-top:18px;flex-wrap:wrap}

/* ============================================================

   MOBILE OVERLAY FOR SIDEBAR

   ============================================================ */

.sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:99}

/* ============================================================

   RESPONSIVE

   ============================================================ */

@media (max-width: 900px){

  .sb{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);z-index:100}

  .sb.open{transform:translateX(0)}

  .sb-overlay.open{display:block}

  .topbar-toggle{display:flex}

  .kpi-g,.ts-g{grid-template-columns:1fr 1fr}

  .g2,.g3,.g4{grid-template-columns:1fr 1fr}

  .task-board{grid-template-columns:1fr 1fr}

  .cal-layout{grid-template-columns:1fr}

  .cal-sb{max-height:300px}

  .sched-layout{grid-template-columns:1fr}

  .int-grid{grid-template-columns:1fr 1fr}

  .kb-col{min-width:185px;max-width:185px}

  .modal{width:100%!important;max-width:100%}

  .mrow{flex-wrap:wrap}

}

@media (max-width: 600px){

  .content{padding:10px 10px}

  .kpi-g,.ts-g{grid-template-columns:1fr 1fr}

  .g2,.g3,.g4{grid-template-columns:1fr}

  .task-board{grid-template-columns:1fr}

  .int-grid{grid-template-columns:1fr}

  .kpi-v{font-size:22px}

  .dt th, .dt td{padding:6px 8px;font-size:10.5px}

  .chips{gap:4px}

  .chip{font-size:9px;padding:3px 8px}

  .sec-t{font-size:13px}

  .modal{border-radius:14px 14px 0 0;position:fixed;bottom:0;left:0;right:0;max-height:88vh;margin:0;width:100%!important;max-width:100%!important;animation:slideup .2s ease}

  .ov{align-items:flex-end;padding:0}

  @keyframes slideup{from{transform:translateY(40px);opacity:0}to{transform:none;opacity:1}}

}

@supports(padding:max(0px)){

  .content{padding-bottom:max(16px,env(safe-area-inset-bottom))}

  .sb-bot{padding-bottom:max(12px,env(safe-area-inset-bottom))}

}

@media (min-width: 901px){

  .sb-overlay{display:none!important}

}

/* ============================================================

   AUTH SCREEN

   ============================================================ */

.auth-overlay{position:fixed;inset:0;background:var(--bg);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px}

.auth-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:36px 40px;width:100%;max-width:380px;box-shadow:var(--sh3);text-align:center}

.auth-logo{font-size:36px;margin-bottom:10px}

.auth-title{font-family:'Unbounded',sans-serif;font-size:20px;font-weight:700;color:var(--t1);margin-bottom:4px}

.auth-sub{font-size:12px;color:var(--t3);margin-bottom:28px}

.auth-field{text-align:left;margin-bottom:14px}

.auth-field label{display:block;font-size:11px;font-weight:600;color:var(--t2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.06em}

.auth-field input{width:100%;background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);padding:10px 14px;color:var(--t1);font-size:13px;font-family:'Manrope',sans-serif;outline:none;transition:border-color .12s}

.auth-field input:focus{border-color:var(--acc);background:var(--surface)}

.auth-btn{width:100%;padding:11px;background:var(--acc);color:#fff;border:none;border-radius:var(--r2);font-size:13px;font-weight:700;font-family:'Manrope',sans-serif;cursor:pointer;transition:background .12s;margin-top:6px}

.auth-btn:hover{background:var(--acc-hover)}

.auth-err{background:var(--red-d);color:var(--red);border-radius:6px;padding:8px 12px;font-size:11.5px;margin-top:10px;display:none}

.auth-err.show{display:block}

.auth-users{margin-top:20px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

.auth-ava{width:34px;height:34px;border-radius:50%;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;background:var(--s3);color:var(--t2);transition:all .12s;title:attr(data-name)}

.auth-ava:hover{border-color:var(--acc);transform:scale(1.1)}

.auth-ava.sel{border-color:var(--acc);background:var(--acc-d);color:var(--acc)}

/* USER BADGE in topbar */

.usr-badge{display:flex;align-items:center;gap:7px;padding:4px 10px 4px 6px;background:var(--s2);border:1px solid var(--border);border-radius:20px;cursor:pointer;transition:all .12s;font-size:11.5px;font-weight:600;color:var(--t2)}

.usr-badge:hover{background:var(--s3);border-color:var(--border2)}

.usr-ava{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0}

.usr-menu{position:absolute;top:100%;right:0;margin-top:4px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh2);min-width:200px;z-index:500;overflow:hidden}

.usr-menu-item{padding:10px 14px;font-size:12px;cursor:pointer;transition:background .08s;display:flex;align-items:center;gap:8px}

.usr-menu-item:hover{background:var(--s2)}

.usr-menu-item.danger{color:var(--red)}

.usr-wrap{position:relative}

/* TASK SCOPE toggle */

.scope-toggle{display:flex;background:var(--s2);border:1.5px solid var(--border);border-radius:20px;padding:2px;gap:0;margin-bottom:12px}

.scope-btn{padding:5px 14px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;transition:all .12s;color:var(--t2);background:none;border:none;font-family:'Manrope',sans-serif;white-space:nowrap}

.scope-btn.active{background:var(--surface);color:var(--t1);box-shadow:0 1px 3px rgba(0,0,0,.1)}

/* ============================================================

   INLINE STATUS / DATE EDITOR

   ============================================================ */

.inline-edit-cell{position:relative}

.inline-status{display:inline-flex;align-items:center;gap:5px;cursor:pointer;border-radius:5px;padding:2px 4px;transition:background .12s;user-select:none}

.inline-status:hover{background:var(--s2)}

.inline-status:hover::after{content:'‚ñæ';font-size:9px;color:var(--t3)}

.inline-date{display:inline-flex;align-items:center;gap:4px;cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--t2);border-radius:4px;padding:2px 5px;transition:background .12s;white-space:nowrap}

.inline-date:hover{background:var(--s2);color:var(--acc)}

.inline-date:hover::after{content:'‚úé';font-size:9px;margin-left:2px;color:var(--acc)}

.inline-date.updated{color:var(--gre);font-weight:700}

/* Dropdown –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ */

.status-dropdown{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh3);min-width:180px;z-index:8000;overflow:hidden;animation:fdropdown .1s ease}

@keyframes fdropdown{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}

.status-dropdown-item{padding:9px 14px;font-size:12px;cursor:pointer;transition:background .08s;display:flex;align-items:center;gap:8px;font-family:'Manrope',sans-serif}

.status-dropdown-item:hover{background:var(--s2)}

.status-dropdown-item.current{background:var(--acc-d);color:var(--acc);font-weight:600}

/* –ü–æ–ø–∞–ø —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã */

.date-popup{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh3);padding:14px;z-index:8000;min-width:220px;animation:fdropdown .1s ease}

.date-popup-title{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px}

.date-popup input{width:100%;background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);padding:7px 10px;color:var(--t1);font-size:13px;font-family:'IBM Plex Mono',monospace;outline:none}

.date-popup input:focus{border-color:var(--acc)}

.date-popup-btns{display:flex;gap:6px;margin-top:10px}

.date-popup-btns button{flex:1;padding:6px;border:none;border-radius:var(--r2);font-size:11px;font-weight:600;cursor:pointer;font-family:'Manrope',sans-serif;transition:background .1s}

.dp-save{background:var(--acc);color:#fff}

.dp-save:hover{background:var(--acc-hover)}

.dp-cancel{background:var(--s2);color:var(--t2)}

.dp-cancel:hover{background:var(--s3)}

.dp-today{background:var(--gre-d);color:var(--gre);font-size:10px;padding:6px 8px}

/* ‚îÄ‚îÄ LANG SWITCHER ‚îÄ‚îÄ */

.lang-sw{display:flex;background:var(--s2);border:1.5px solid var(--border);border-radius:20px;padding:2px;gap:0}

.lang-btn{padding:4px 11px;border-radius:16px;font-size:10.5px;font-weight:700;cursor:pointer;

  color:var(--t3);background:none;border:none;font-family:'Manrope',sans-serif;letter-spacing:.04em;transition:all .12s}

.lang-btn.active{background:var(--surface);color:var(--t1);box-shadow:0 1px 3px rgba(0,0,0,.1)}

/* ‚îÄ‚îÄ DELETE BUTTON ‚îÄ‚îÄ */

.del-btn{background:none;border:none;cursor:pointer;padding:4px 5px;border-radius:5px;

  color:var(--t4);font-size:13px;transition:all .12s;line-height:1}

.del-btn:hover{background:var(--red-d);color:var(--red)}

/* ‚îÄ‚îÄ DELETE CONFIRM POPUP ‚îÄ‚îÄ */

.del-pop{position:fixed;background:var(--surface);border:1px solid var(--border);

  border-radius:var(--r);box-shadow:var(--sh3);padding:16px;z-index:9000;

  min-width:230px;max-width:270px;animation:fdropdown .1s ease}

.del-pop h4{font-size:12.5px;font-weight:700;color:var(--t1);margin-bottom:3px}

.del-pop p{font-size:11px;color:var(--t3);margin-bottom:12px;line-height:1.4}

.del-pop-btns{display:flex;gap:6px}

.del-pop-btns button{flex:1;padding:7px;border:none;border-radius:var(--r2);

  font-size:11.5px;font-weight:600;cursor:pointer;font-family:'Manrope',sans-serif;transition:.1s}

.dpc{background:var(--s2);color:var(--t2)}.dpc:hover{background:var(--s3)}

.dpd{background:var(--red);color:#fff}.dpd:hover{background:#b91c1c}

</style>

</head>

<body>

<div id="loading-bar" class="loading-bar"></div>

<div class="sb-overlay" id="sb-overlay" onclick="closeSb()"></div>

<div class="app">

<!-- ===================== SIDEBAR ===================== -->

<aside class="sb" id="sidebar">

  <div class="sb-logo">

    <div class="sb-logo-icon">üáµüáπ</div>

    <div class="sb-logo-wrap">

      <div class="sb-logo-t">MIGRALL</div>

      <div class="sb-logo-s">CRM v4 ¬∑ Portugal</div>

    </div>

  </div>

  <nav class="sb-nav">

    <div class="sb-sec">–û–±–∑–æ—Ä</div>

    <div class="ni active" onclick="showView('dashboard',this)"><span class="ni-ic">‚ä°</span>–î–∞—à–±–æ—Ä–¥</div>

    <div class="sb-sec">–ö–ª–∏–µ–Ω—Ç—ã</div>

    <div class="ni" onclick="showView('clients',this)"><span class="ni-ic">‚óâ</span>–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</div>

    <div class="ni" onclick="showView('kanban',this)"><span class="ni-ic">‚ñ¶</span>–ö–∞–Ω–±–∞–Ω / Pipeline</div>

    <div class="sb-sec">–°—Ç–∞—Ç—É—Å—ã</div>

    <div class="ni" onclick="showView('aima',this)"><span class="ni-ic">üìã</span>–ü—Ä–æ–≤–µ—Ä–∫–∏ AIMA<span class="ni-bdg" id="bdg-aima">27</span></div>

    <div class="ni" onclick="showView('visad',this)"><span class="ni-ic">‚úà</span>–í–∏–∑–∞ D</div>

    <div class="ni" onclick="showView('courts',this)"><span class="ni-ic">‚öñ</span>–°—É–¥—ã</div>

    <div class="ni" onclick="showView('citizenship',this)"><span class="ni-ic">üèõ</span>–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</div>

    <div class="ni" onclick="showView('rights',this)"><span class="ni-ic">üöó</span>–ü—Ä–∞–≤–∞</div>

    <div class="sb-sec">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>

    <div class="ni" onclick="showView('schedule',this)"><span class="ni-ic">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>

    <div class="ni" onclick="showView('calendar',this)"><span class="ni-ic">‚ñ§</span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>

    <div class="sb-sec">–†–∞–±–æ—Ç–∞</div>

    <div class="ni" onclick="showView('tasks',this)"><span class="ni-ic">‚òë</span>–ó–∞–¥–∞—á–∏<span class="ni-bdg y" id="bdg-tasks">0</span></div>

    <div class="ni" onclick="showView('integration',this)"><span class="ni-ic">‚ö°</span>API / –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>

  </nav>

  <div class="sb-bot">

    <button class="sync-btn" onclick="doSync()"><span id="sync-spin">‚Üª</span> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>

    <div class="api-status"><div class="api-dot" id="api-dot"></div><span id="api-status-txt">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>

  </div>

</aside>

<!-- ===================== MAIN ===================== -->

<main class="main">

  <div class="topbar">

    <button class="topbar-toggle" onclick="openSb()">‚ò∞</button>

    <div class="pg-title" id="pg-title">–î–∞—à–±–æ—Ä–¥</div>

    <input class="tb-search" placeholder="üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞, ID, telegram..." id="tb-search" oninput="handleSearch(this.value)">

    <div class="lang-sw">

      <button class="lang-btn active" onclick="setLang('ru',this)">RU</button>

      <button class="lang-btn" onclick="setLang('pt',this)">PT</button>

    </div>

    <div class="tb-right">

      <div class="live-dot"></div>

      <div class="usr-wrap" id="usr-wrap">

        <div class="usr-badge" id="usr-badge" onclick="toggleUserMenu()">

          <div class="usr-ava" id="usr-ava" style="background:var(--acc)">?</div>

          <span id="usr-name-badge">‚Äî</span>

          <span style="color:var(--t3);font-size:10px">‚ñæ</span>

        </div>

        <div class="usr-menu" id="usr-menu" style="display:none">

          <div style="padding:12px 14px;border-bottom:1px solid var(--border)">

            <div id="um-name" style="font-size:13px;font-weight:700;color:var(--t1)">‚Äî</div>

            <div id="um-role" style="font-size:10.5px;color:var(--t3);margin-top:1px">‚Äî</div>

          </div>

          <div class="usr-menu-item" onclick="showView('tasks',null);closeUserMenu()">‚òë –ú–æ–∏ –∑–∞–¥–∞—á–∏</div>

          <div class="usr-menu-item" onclick="showProfileModal()">‚öô –ü—Ä–æ—Ñ–∏–ª—å</div>

          <div class="usr-menu-item danger" onclick="doLogout()">‚¨° –í—ã–π—Ç–∏</div>

        </div>

      </div>

    </div>

  </div>

  <div class="content">

  <!-- =================== DASHBOARD =================== -->

  <div class="view active" id="view-dashboard">

    <div class="kpi-g">

      <div class="kpi blu"><div class="kpi-l" id="kpi-total-l">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div><div class="kpi-v" id="kpi-total">‚Äî</div><div class="kpi-s">–í –±–∞–∑–µ CRM</div></div>

      <div class="kpi yel"><div class="kpi-l" id="kpi-review-l">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div><div class="kpi-v" id="kpi-review">‚Äî</div><div class="kpi-s" id="kpi-review-s">–ê–Ω–∞–ª–∏–∑ AIMA</div></div>

      <div class="kpi gre"><div class="kpi-l" id="kpi-approved-l">–ê–ø—Ä—É–≤</div><div class="kpi-v" id="kpi-approved">‚Äî</div><div class="kpi-s" id="kpi-approved-s">–û–¥–æ–±—Ä–µ–Ω–æ</div></div>

      <div class="kpi red"><div class="kpi-l" id="kpi-meets-l">–í—Å—Ç—Ä–µ—á —Å–µ–≥–æ–¥–Ω—è</div><div class="kpi-v" id="kpi-meets">‚Äî</div><div class="kpi-s" id="kpi-meets-s">‚Äî</div></div>

    </div>

    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">

      <div style="font-size:11px;font-weight:700;color:var(--t2)" id="ts-label-stat">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á –∑–∞:</div>

      <div class="ts-filter">

        <div class="ts-fc active" id="ts-fc-day" onclick="setTaskPeriod('day',this)">–î–µ–Ω—å</div>

        <div class="ts-fc" id="ts-fc-week" onclick="setTaskPeriod('week',this)">–ù–µ–¥–µ–ª—è</div>

        <div class="ts-fc" id="ts-fc-month" onclick="setTaskPeriod('month',this)">–ú–µ—Å—è—Ü</div>

      </div>

    </div>

    <div class="ts-g">

      <div class="ts-card"><div class="ts-l">–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div><div class="ts-v" id="ts-tot">0</div></div>

      <div class="ts-card"><div class="ts-l">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div><div class="ts-v" style="color:var(--yel)" id="ts-prog">0</div></div>

      <div class="ts-card"><div class="ts-l">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div><div class="ts-v" style="color:var(--gre)" id="ts-done">0</div></div>

      <div class="ts-card"><div class="ts-l">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div><div class="ts-v" style="color:var(--red)" id="ts-over">0</div></div>

    </div>

    <div class="g2" style="margin-bottom:12px">

      <div class="panel">

        <div class="ph">

          <div class="ph-title" id="dash-my-tasks-title">–ú–æ–∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏</div>

          <div class="ph-cnt" id="dash-my-tasks-cnt">0</div>

        </div>

        <div id="dash-my-tasks"></div>

      </div>

      <div class="panel">

        <div class="ph"><div class="ph-title">–ë–ª–∏–∂–∞–π—à–∏–µ –≤—Å—Ç—Ä–µ—á–∏</div><div class="ph-cnt">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</div></div>

        <div id="dash-meets"></div>

      </div>

    </div>

    <div class="g2">

      <div class="panel">

        <div class="ph"><div class="ph-title">–î–∞–≤–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ AIMA</div><div class="ph-cnt">–ü–æ –¥–∞—Ç–µ ‚Üë</div></div>

        <div id="dash-aima"></div>

      </div>

      <div class="panel">

        <div class="ph"><div class="ph-title">–°—É–¥—ã ‚Äî –ø–æ –¥–∞–≤–Ω–æ—Å—Ç–∏</div></div>

        <div id="dash-courts"></div>

      </div>

    </div>

    <div class="g2">

      <div class="panel">

        <div class="ph"><div class="ph-title">–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</div></div>

        <div id="dash-cit"></div>

      </div>

      <div class="panel">

        <div class="ph"><div class="ph-title">–ü—Ä–∞–≤–∞</div></div>

        <div id="dash-rights"></div>

      </div>

    </div>

  </div>

  <!-- =================== CLIENTS =================== -->

  <div class="view" id="view-clients">

    <div class="sec-h">

      <div class="sec-t">–ö–ª–∏–µ–Ω—Ç—ã</div>

      <div class="sec-a">

        <button class="btn btn-p btn-sm" onclick="openAddClientModal()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>

      </div>

    </div>

    <div class="panel">

      <div class="dt-wrap"><table class="dt">

        <thead><tr><th>ID</th><th>–ò–º—è</th><th>Telegram</th><th>–¢–∏–ø —É—Å–ª—É–≥–∏</th><th>–≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏</th><th>–ü–æ–¥—ç—Ç–∞–ø</th><th>–ü–æ—Å–ª. –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th></tr></thead>

        <tbody id="clients-tbody"></tbody>

      </table></div>

      </div>

  </div>

  <!-- =================== KANBAN =================== -->

  <div class="view" id="view-kanban">

    <div class="sec-h">

      <div class="sec-t">Kanban Pipeline</div>

      <div class="chips sec-a" id="kb-chips" style="margin-bottom:0"></div>

    </div>

    <div class="kb-wrap" id="kb-board"></div>

  </div>

  <!-- =================== AIMA =================== -->

  <div class="view" id="view-aima">

    <div class="sec-h"><div class="sec-t">–ü—Ä–æ–≤–µ—Ä–∫–∏ AIMA</div></div>

    <div class="chips" id="aima-filter-chips">

      <div class="chip active" onclick="filterAIMA('all',this)">–í—Å–µ</div>

      <div class="chip" onclick="filterAIMA('–ê–ø—Ä—É–≤',this)">–ê–ø—Ä—É–≤</div>

      <div class="chip" onclick="filterAIMA('–ê–Ω–∞–ª–∏–∑',this)">–ê–Ω–∞–ª–∏–∑</div>

      <div class="chip" onclick="filterAIMA('–ü–µ—á–∞—Ç—å',this)">–ü–µ—á–∞—Ç—å</div>

      <div class="chip" onclick="filterAIMA('–î–æ–∑–∞–ø—Ä–æ—Å',this)">–î–æ–∑–∞–ø—Ä–æ—Å</div>

    </div>

    <div class="panel">

      <div class="dt-wrap"><table class="dt">

        <thead><tr><th>‚Ññ</th><th>–§–ò–û</th><th>NIPC / –î–µ–ª–æ</th><th>–î–†</th><th>–ü–∞—Å–ø–æ—Ä—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</th><th>–°–µ–∫—Ü–∏—è</th><th></th></tr></thead>

        <tbody id="aima-tbody"></tbody>

      </table></div>

      </div>

  </div>

  <!-- =================== VISA D =================== -->

  <div class="view" id="view-visad">

    <div class="sec-h"><div class="sec-t">–í–∏–∑–∞ D ‚Äî –°—Ç–∞—Ç—É—Å—ã</div><div class="sec-a"><button class="btn btn-p btn-sm" onclick="editVisaD(-1)">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div>

    <div class="panel">

      <div class="dt-wrap"><table class="dt">

        <thead><tr><th>‚Ññ</th><th>–§–ò–û</th><th>–¢–∏–ø</th><th>–î–†</th><th>–ü–∞—Å–ø–æ—Ä—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</th><th>–ì–æ—Ä–æ–¥</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th></th></tr></thead>

        <tbody id="visad-tbody"></tbody>

      </table></div>

      </div>

  </div>

  <!-- =================== COURTS =================== -->

  <div class="view" id="view-courts">

    <div class="sec-h"><div class="sec-t">–°—É–¥—ã</div><div class="sec-a"><button class="btn btn-p btn-sm" onclick="editCourt(-1)">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div>

    <div class="chips" id="courts-chips">

      <div class="chip active" onclick="filterCourts('all',this)">–í—Å–µ</div>

      <div class="chip" onclick="filterCourts('90.2',this)">90.2</div>

      <div class="chip" onclick="filterCourts('98.2',this)">98.2</div>

      <div class="chip" onclick="filterCourts('91',this)">91</div>

      <div class="chip" onclick="filterCourts('88.2',this)">88.2</div>

      <div class="chip" onclick="filterCourts('15',this)">15 —Å—Ç.</div>

    </div>

    <div class="panel">

      <div class="dt-wrap"><table class="dt">

        <thead><tr><th>‚Ññ</th><th>–§–ò–û</th><th>–°—Ç–∞—Ç—å—è</th><th>–î–∞—Ç–∞</th><th>–ú–µ—Å—Ç–æ</th><th>–≠—Ç–∞–ø</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–±–Ω–æ–≤–ª—ë–Ω</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th></th></tr></thead>

        <tbody id="courts-tbody"></tbody>

      </table></div>

      </div>

  </div>

  <!-- =================== CITIZENSHIP =================== -->

  <div class="view" id="view-citizenship">

    <div class="sec-h"><div class="sec-t">–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</div><div class="sec-a"><button class="btn btn-p btn-sm" onclick="editCitizenship(-1)">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div>

    <div class="panel">

      <div class="dt-wrap"><table class="dt">

        <thead><tr><th>‚Ññ</th><th>–§–ò–û</th><th>–¢–∏–ø</th><th>–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏</th><th>–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä</th><th>–≠—Ç–∞–ø</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–±–Ω–æ–≤–ª—ë–Ω</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th></th></tr></thead>

        <tbody id="cit-tbody"></tbody>

      </table></div>

      </div>

  </div>

  <!-- =================== RIGHTS =================== -->

  <div class="view" id="view-rights">

    <div class="sec-h"><div class="sec-t">–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞</div><div class="sec-a"><button class="btn btn-p btn-sm" onclick="editRights(-1)">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div>

    <div class="panel">

      <div class="dt-wrap"><table class="dt">

        <thead><tr><th>‚Ññ</th><th>–§–ò–û</th><th>–°—Ç—Ä–∞–Ω–∞ –ø—Ä–∞–≤</th><th>–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏</th><th>–≠—Ç–∞–ø</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–±–Ω–æ–≤–ª—ë–Ω</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th></th></tr></thead>

        <tbody id="rights-tbody"></tbody>

      </table></div>

      </div>

  </div>

  <!-- =================== SCHEDULE =================== -->

  <div class="view" id="view-schedule">

    <div class="sec-h"><div class="sec-t">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á</div><div class="sec-a"><button class="btn btn-p btn-sm" onclick="openBookSlotModal()">+ –ó–∞–Ω—è—Ç—å —Å–ª–æ—Ç</button></div></div>

    <div class="sched-layout">

      <div class="sched-mini">

        <div class="sched-mnav">

          <button class="sched-mb" onclick="schedMon(-1)">‚Äπ</button>

          <div class="sched-mnav-t" id="sched-m-title">–§–µ–≤—Ä–∞–ª—å 2026</div>

          <button class="sched-mb" onclick="schedMon(1)">‚Ä∫</button>

        </div>

        <div style="padding:4px 6px 2px"><div class="sched-mg" id="sched-mg"></div></div>

        <div class="sched-slots">

          <div class="sched-slots-t">–°–ª–æ—Ç—ã: <span id="sched-sel-d" style="color:var(--acc)">–≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</span></div>

          <div class="sched-sl" id="sched-sl"></div>

        </div>

      </div>

      <div>

        <div class="chips" id="sched-status-chips">

          <div class="chip active" onclick="filterMeetings('all',this)">–í—Å–µ</div>

          <div class="chip" onclick="filterMeetings('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',this)">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</div>

          <div class="chip" onclick="filterMeetings('–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',this)">–û–∂–∏–¥–∞–µ—Ç</div>

        </div>

        <div class="panel">

          <div class="dt-wrap"><table class="dt">

            <thead><tr><th>–î–∞—Ç–∞ / –í—Ä–µ–º—è</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>Telegram</th><th>–°—Ç–∞—Ç—É—Å</th><th>Google Meet</th></tr></thead>

            <tbody id="sched-tbody"></tbody>

          </table></div>

      </div>

      </div>

    </div>

  </div>

  <!-- =================== CALENDAR =================== -->

  <div class="view" id="view-calendar">

    <div class="sec-h"><div class="sec-t">–ö–æ–º–∞–Ω–¥–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>

    <div class="cal-layout">

      <div class="cal-wrap">

        <div class="cal-nav">

          <button class="cal-nav-btn" onclick="calMon(-1)">‚Üê</button>

          <div class="cal-month" id="cal-month">–§–µ–≤—Ä–∞–ª—å 2026</div>

          <button class="cal-nav-btn" onclick="calMon(1)">‚Üí</button>

        </div>

        <div class="cal-dows"><div class="cal-dow">–ü–Ω</div><div class="cal-dow">–í—Ç</div><div class="cal-dow">–°—Ä</div><div class="cal-dow">–ß—Ç</div><div class="cal-dow">–ü—Ç</div><div class="cal-dow">–°–±</div><div class="cal-dow">–í—Å</div></div>

        <div class="cal-grid" id="cal-grid"></div>

      </div>

      <div class="cal-sb">

        <div class="cal-sb-d" id="cal-sel-d">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</div>

        <div class="cal-sb-evts" id="cal-sb-evts"><div class="cal-empty">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–µ–Ω—å</div></div>

      </div>

    </div>

  </div>

  <!-- =================== TASKS =================== -->

  <div class="view" id="view-tasks">

    <div class="sec-h">

      <div class="sec-t">–ó–∞–¥–∞—á–∏</div>

      <div class="sec-a">

        <div class="scope-toggle">

          <button class="scope-btn active" id="scope-mine" onclick="setTaskScope('mine',this)">üë§ –ú–æ–∏</button>

          <button class="scope-btn" id="scope-all" onclick="setTaskScope('all',this)">üë• –í—Å–µ</button>

        </div>

        <input class="mi" style="max-width:130px;padding:5px 9px;font-size:11px" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ ‚Ññ –∫–ª–∏–µ–Ω—Ç–∞" id="task-client-filter" oninput="filterTasksByClient(this.value)">

        <button class="btn btn-p btn-sm" onclick="openAddTaskModal()">+ –ó–∞–¥–∞—á–∞</button>

      </div>

    </div>

    <div class="task-board" id="task-board"></div>

  </div>

  <!-- =================== INTEGRATION =================== -->

  <div class="view" id="view-integration">

    <div class="sec-h"><div class="sec-t">API / –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div></div>

    <div class="int-grid">

      <div class="int-card"><div class="int-ic">ü§ñ</div><div class="int-nm">CRM –ö–ª–∏–µ–Ω—Ç—ã (Telegram)</div><div class="int-id">1NBSRoOn_tEIZrn0384BF_uFNBM8EaxDCr5AylipPiek</div><div class="int-sr"><div class="int-dot ok" id="ds-crm-dot"></div><span id="ds-crm-txt">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div></div>

      <div class="int-card"><div class="int-ic">üìã</div><div class="int-nm">–°—Ç–∞—Ç—É—Å—ã AIMA (–ü—Ä–æ–≤–µ—Ä–∫–∏)</div><div class="int-id">1zyn8_ld50J99XoczAiKIjIuL0B5HHl6YVPKvhb3S0so</div><div class="int-sr"><div class="int-dot ok" id="ds-aima-dot"></div><span id="ds-aima-txt">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div></div>

      <div class="int-card"><div class="int-ic">‚öñÔ∏è</div><div class="int-nm">–°—É–¥—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</div><div class="int-id">1u8OPwmGq4YQ3VRekeVGt7TMj2l8dgpxWOri9fb89Gik</div><div class="int-sr"><div class="int-dot w" id="ds-courts-dot"></div><span id="ds-courts-txt">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div></div>

      <div class="int-card"><div class="int-ic">üìÖ</div><div class="int-nm">–ì—Ä–∞—Ñ–∏–∫ –≤—Å—Ç—Ä–µ—á</div><div class="int-id">1PFdrMsmuXcsFaZ66b2RlWNlequPMCJW5mcDB4lvRaXc</div><div class="int-sr"><div class="int-dot ok" id="ds-sched-dot"></div><span id="ds-sched-txt">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div></div>

      <div class="int-card"><div class="int-ic">üìä</div><div class="int-nm">–°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—á –∫–ª–∏–µ–Ω—Ç–æ–≤</div><div class="int-id">1uZm3AuTMyMOmdZ9ZJW-59hkJ4QRTOgoo</div><div class="int-sr"><div class="int-dot ok" id="ds-subs-dot"></div><span id="ds-subs-txt">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div></div>

      <div class="int-card"><div class="int-ic">üóìÔ∏è</div><div class="int-nm">–ö–æ–º–∞–Ω–¥–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</div><div class="int-id">c_020552‚Ä¶@group.calendar.google.com</div><div class="int-sr"><div class="int-dot w"></div><span>–¢—Ä–µ–±—É–µ—Ç—Å—è OAuth 2.0</span></div></div>

    </div>

    <div class="api-info">

      <div style="font-size:11px;font-weight:700;color:var(--t1);margin-bottom:8px">üîê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ API ‚Äî –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä Render</div>

      <pre>

–í—Å–µ API-–∫–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—ã Render (Environment Variables):

  GOOGLE_SHEETS_API_KEY   ‚Äî –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets

  GOOGLE_SERVICE_ACCOUNT  ‚Äî JSON —Å–µ—Ä–≤–∏—Å-–∞–∫–∫–∞—É–Ω—Ç–∞ Google

  SHEETS_SPREADSHEET_ID_* ‚Äî ID —Ç–∞–±–ª–∏—Ü

CRM ‚Üî Backend (Render) ‚Üî Google Sheets

–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

  GET  /api/clients          ‚Üí —á–∏—Ç–∞–µ—Ç –∏–∑ –ª–∏—Å—Ç–∞ CRM_Clients

  POST /api/clients          ‚Üí —Å–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä–æ–∫—É –≤ –ª–∏—Å—Ç–µ CRM_Clients

  PUT  /api/clients/:id      ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –ø–æ ID

  GET  /api/statuses         ‚Üí —á–∏—Ç–∞–µ—Ç –°–ü–ò–°–û–ö –ü–†–û–í–ï–†–û–ö

  PUT  /api/statuses/:num    ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å + –¥–∞—Ç—É –ø—Ä–æ–≤–µ—Ä–∫–∏

  GET  /api/courts           ‚Üí —á–∏—Ç–∞–µ—Ç –ª–∏—Å—Ç —Å—É–¥–æ–≤

  PUT  /api/courts/:num      ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å—É–¥–∞

  GET  /api/schedule         ‚Üí —á–∏—Ç–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

  POST /api/schedule         ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ª–æ—Ç

  GET  /api/visad            ‚Üí —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –≤–∏–∑ D

  PUT  /api/visad/:num       ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤–∏–∑—ã

  PUT  /api/citizenship/:num ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ

  PUT  /api/rights/:num      ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ CRM: –¥–∞–Ω–Ω—ã–µ ‚Üí Render API ‚Üí Google Sheets

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ Sheets: Sheets Apps Script ‚Üí POST /api/webhook ‚Üí CRM –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

–ö–∞–ª–µ–Ω–¥–∞—Ä—å: –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ Google Calendar API (OAuth 2.0)

</pre>

    </div>

  </div>

  </div><!-- /content -->

</main>

</div><!-- /app -->

<!-- MODAL OVERLAY -->

<div class="ov" id="modal-ov" onclick="closeOv(event)">

  <div class="modal" id="modal-box"><div id="modal-in"></div></div>

</div>

<script>

'use strict';

// ============================================================

// API LAYER ‚Äî calls go to /api/* on Render

// Keys are stored as env vars on Render, never in this file

// ============================================================

const API_BASE = window.API_BASE || '/api'; // Override in production

let API_ONLINE = false;

async function apiFetch(path, options={}){

  try {

    const res = await fetch(API_BASE + path, {

      headers:{'Content-Type':'application/json',...(options.headers||{})},

      ...options,

    });

    if(!res.ok) throw new Error(`HTTP ${res.status}`);

    return await res.json();

  } catch(e) {

    console.warn('API unavailable, using local data:', e.message);

    return null;

  }

}

async function apiPut(path, data){

  const res = await apiFetch(path, {method:'PUT', body:JSON.stringify(data)});

  return res;

}

async function apiPost(path, data){

  const res = await apiFetch(path, {method:'POST', body:JSON.stringify(data)});

  return res;

}

// ============================================================

// USERS ‚Äî local registry (passwords checked against API /login)

// ============================================================

const USERS_LOCAL = [

  {login:'arina',    name:'–ê—Ä–∏–Ω–∞',    role:'manager',  color:'#3b6ff5', initials:'–ê–†', canSeeAll:false},

  {login:'alina',    name:'–ê–ª–∏–Ω–∞',    role:'manager',  color:'#0d9488', initials:'–ê–õ', canSeeAll:false},

  {login:'oleg',     name:'–û–ª–µ–≥',     role:'manager',  color:'#7c3aed', initials:'–û–õ', canSeeAll:false},

  {login:'stefani',  name:'–°—Ç–µ—Ñ–∞–Ω–∏',  role:'manager',  color:'#db2777', initials:'–°–¢', canSeeAll:false},

  {login:'paula',    name:'–ü–∞—É–ª–∞',    role:'manager',  color:'#ea580c', initials:'–ü–ê', canSeeAll:false},

  {login:'admin',    name:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', role:'admin', color:'#16a34a', initials:'AD', canSeeAll:true},

];

// –ü–∞—Ä–æ–ª–∏ ‚Äî –¥–ª—è –¥–µ–º–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –∑–¥–µ—Å—å. –í –ø—Ä–æ–¥–µ: POST /api/login ‚Üí —Ç–æ–∫–µ–Ω

const DEMO_PASSWORDS = {arina:'arina123',alina:'alina123',oleg:'oleg123',stefani:'stefani123',paula:'paula123',admin:'admin2024'};

let currentUser = null;

let taskScope = 'mine'; // 'mine' | 'all'

function initAuth(){

  // Build quick-login avatars

  const wrap = g('auth-quick');

  if(wrap) wrap.innerHTML = USERS_LOCAL.map(u=>`

    <div class="auth-ava" data-login="${u.login}" title="${u.name}"

      onclick="quickFill('${u.login}')"

      style="background:${u.color};color:#fff;border-color:transparent">

      ${u.initials}

    </div>`).join('');

  

  // Check localStorage for saved session

  try{

    const saved = localStorage.getItem('crm_user');

    if(saved){const u=JSON.parse(saved);loginAs(u);return;}

  }catch(e){}

  

  g('auth-overlay').style.display='flex';

}

function quickFill(login){

  g('auth-user').value = login;

  const pwd = DEMO_PASSWORDS[login] || '';

  g('auth-pass').value = pwd;

  // Highlight avatar

  document.querySelectorAll('.auth-ava').forEach(a=>{

    a.style.borderColor = a.dataset.login===login?'var(--acc)':'transparent';

  });

  g('auth-pass').focus();

}

async function doLogin(){

  const login = (g('auth-user').value||'').trim().toLowerCase();

  const pass  = (g('auth-pass').value||'').trim();

  const err   = g('auth-err');

  err.classList.remove('show');

  

  // Try API first

  const apiResult = await apiFetch('/login', {method:'POST', body:JSON.stringify({login,password:pass})}).catch(()=>null);

  

  if(apiResult && apiResult.user){

    loginAs(apiResult.user);

    return;

  }

  

  // Fallback: local check

  const user = USERS_LOCAL.find(u=>u.login===login);

  if(!user){err.textContent='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';err.classList.add('show');return;}

  if(DEMO_PASSWORDS[login] && pass !== DEMO_PASSWORDS[login]){

    err.textContent='–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';err.classList.add('show');return;

  }

  loginAs(user);

}

function loginAs(user){

  currentUser = user;

  try{localStorage.setItem('crm_user', JSON.stringify(user));}catch(e){}

  

  // Hide auth screen

  const overlay = g('auth-overlay');

  if(overlay){overlay.style.opacity='0';overlay.style.transition='opacity .25s';setTimeout(()=>overlay.style.display='none',250);}

  

  // Update topbar badge

  const ava = g('usr-ava');

  if(ava){ava.textContent=user.initials||user.name[0];ava.style.background=user.color||'var(--acc)';}

  const nb = g('usr-name-badge');

  if(nb) nb.textContent = user.name;

  

  // Update user menu

  const un=g('um-name'), ur=g('um-role');

  if(un) un.textContent=user.name;

  if(ur) ur.textContent=user.role==='admin'?'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ¬∑ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É':'–ú–µ–Ω–µ–¥–∂–µ—Ä';

  

  // Update sidebar (admin sees admin badge)

  if(user.role==='admin' || user.canSeeAll){

    const badge=document.createElement('span');

    badge.className='ni-bdg g';badge.textContent='ADM';badge.style.fontSize='7px';

    const logo=document.querySelector('.sb-logo-s');

    if(logo)logo.textContent='CRM v4 ¬∑ Admin';

  }

  

  // Render tasks for this user

  taskScope = (user.role==='admin'||user.canSeeAll)?'all':'mine';

  // Update scope toggle buttons

  setTimeout(()=>{

    const mine=g('scope-mine'), all=g('scope-all');

    if(mine&&all){

      mine.classList.toggle('active', taskScope==='mine');

      all.classList.toggle('active', taskScope==='all');

    }

  }, 100);

  renderAll();

  doSync();

  

  toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+user.name+' üëã');

}

function doLogout(){

  try{localStorage.removeItem('crm_user');}catch(e){}

  currentUser=null;

  closeUserMenu();

  // Reset and show auth

  g('auth-user').value='';g('auth-pass').value='';

  g('auth-err').classList.remove('show');

  const overlay=g('auth-overlay');

  overlay.style.opacity='0';overlay.style.display='flex';

  setTimeout(()=>{overlay.style.opacity='1';overlay.style.transition='opacity .2s';},10);

}

function toggleUserMenu(){

  const m=g('usr-menu');

  if(m.style.display==='none'){m.style.display='block';setTimeout(()=>document.addEventListener('click',closeUserMenuOutside),50);}

  else closeUserMenu();

}

function closeUserMenu(){const m=g('usr-menu');if(m)m.style.display='none';document.removeEventListener('click',closeUserMenuOutside);}

function closeUserMenuOutside(e){if(!g('usr-wrap')?.contains(e.target))closeUserMenu();}

function showProfileModal(){

  if(!currentUser)return;

  closeUserMenu();

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">–ü—Ä–æ—Ñ–∏–ª—å</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px;padding:14px;background:var(--s2);border-radius:var(--r2)">

      <div style="width:48px;height:48px;border-radius:50%;background:${currentUser.color||'var(--acc)'};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0">${currentUser.initials||currentUser.name[0]}</div>

      <div>

        <div style="font-size:16px;font-weight:700">${currentUser.name}</div>

        <div style="font-size:11px;color:var(--t3);margin-top:2px">${currentUser.role==='admin'?'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä':'–ú–µ–Ω–µ–¥–∂–µ—Ä'} ¬∑ @${currentUser.login}</div>

      </div>

    </div>

    <div style="background:var(--acc-d);border-radius:6px;padding:10px 12px;font-size:11.5px;color:var(--acc)">

      ‚Ñπ –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è ‚Äî —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∏—Å—Ç–µ–º—ã. –ü–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Render –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.

    </div>

    <div class="mft"><button class="btn btn-g" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>

  `,'narrow');

}

// ============================================================

// TASK SCOPE TOGGLE ‚Äî –ú–æ–∏ / –í—Å–µ

// ============================================================

function setTaskScope(scope, el){

  taskScope = scope;

  document.querySelectorAll('.scope-btn').forEach(b=>b.classList.remove('active'));

  if(el) el.classList.add('active');

  renderTasks();

  renderTaskStats();

}

function getVisibleTasks(){

  if(!currentUser) return tasks;

  if(taskScope==='all' || currentUser.role==='admin' || currentUser.canSeeAll) return tasks;

  // Filter by current user's name

  return tasks.filter(t => !t.assignee || t.assignee==='‚Äî' || t.assignee===currentUser.name);

}

// ============================================================

// CONSTANTS

// ============================================================

const SVC_TYPES = [

  '–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)',

  '–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã)',

  '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –í–ù–ñ','–°—É–¥','–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ','–ü—Ä–∞–≤–∞','–†–∞–∑–æ–≤–∞—è —É—Å–ª—É–≥–∞',

];

const SVC_COLORS = {

  '–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)':'var(--acc)',

  '–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã)':'var(--tea)',

  '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –í–ù–ñ':'var(--yel)',

  '–°—É–¥':'var(--pur)',

  '–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ':'var(--ora)',

  '–ü—Ä–∞–≤–∞':'var(--gre)',

  '–†–∞–∑–æ–≤–∞—è —É—Å–ª—É–≥–∞':'var(--t3)',

};

const SUBSTAGES = {

  '–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)':['–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ','–ó–∞–ø–∏—Å–∞–Ω –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ','–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞–Ω—ã –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ','‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –í–∏–∑–∞ D','–í–∏–∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∞','–í–∏–∑–∞ –≤–∫–ª–µ–µ–Ω–∞','–ö–ª–∏–µ–Ω—Ç –≤ –ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏','–ó–∞–ø–∏—Å—å –≤ AIMA –ø–æ–ª—É—á–µ–Ω–∞','–î–æ–∫—É–º–µ–Ω—Ç—ã –≤ AIMA –ø–æ–¥–∞–Ω—ã','‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –í–ù–ñ'],

  '–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã)':['–ó–∞–ø–∏—Å—å –≤ AIMA –ø–æ–ª—É—á–µ–Ω–∞','–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞–Ω—ã','‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –í–ù–ñ'],

  '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –í–ù–ñ':['–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã','–ó–∞–ø–∏—Å—å –ø–æ–ª—É—á–µ–Ω–∞','–ü–æ–¥–∞—á–∞ —Å–¥–µ–ª–∞–Ω–∞','–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è','–ê–ø—Ä—É–≤/–ì–æ—Ç–æ–≤–æ'],

  '–°—É–¥':['–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã','–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥ —Å–¥–µ–ª–∞–Ω–∞','‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞','–†–µ–∑—É–ª—å—Ç–∞—Ç'],

  '–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ':['–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã','–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä –ø–æ–ª—É—á–µ–Ω','‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–∞'],

  '–ü—Ä–∞–≤–∞':['–î–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏–Ω—è—Ç—ã','–ü—Ä–∞–≤–∞ –∑–∞–≤–µ—Ä–µ–Ω—ã','–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','–ê–ø—Ä—É–≤ –ø–æ–ª—É—á–µ–Ω','–ó–∞–ø–∏—Å—å —Å–¥–µ–ª–∞–Ω–∞','–ì–æ—Ç–æ–≤–æ'],

  '–†–∞–∑–æ–≤–∞—è —É—Å–ª—É–≥–∞':[],

};

const STAGE_TASKS = {

  '–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ':['–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤','–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'],

  '–ó–∞–ø–∏—Å–∞–Ω –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ':['–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º','–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'],

  '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞–Ω—ã –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ':['–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ','–î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –í–∏–∑–∞ D'],

  '–í–∏–∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∞':['–£–≤–µ–¥–æ–º–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞','–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤–∫–ª–µ–π–∫—É –≤–∏–∑—ã'],

  '–ö–ª–∏–µ–Ω—Ç –≤ –ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏':['–ó–∞–ø–∏—Å–∞—Ç—å –≤ AIMA','–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã AIMA'],

  '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞–Ω—ã':['–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ','–î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –í–ù–ñ'],

  '–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã':['–ü–µ—Ä–µ–¥–∞—Ç—å –∞–¥–≤–æ–∫–∞—Ç—É','–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç–Ω–æ—Å—Ç—å'],

  '–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥ —Å–¥–µ–ª–∞–Ω–∞':['–ü–æ–ª—É—á–∏—Ç—å –∫–≤–∏—Ç–∞–Ω—Ü–∏—é','–ù–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ'],

  '–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞':['–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä'],

  '–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä –ø–æ–ª—É—á–µ–Ω':['–ó–∞–Ω–µ—Å—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É','–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ'],

  '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏–Ω—è—Ç—ã':['–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–µ—Ä–µ–Ω–∏–µ'],

  '–ü—Ä–∞–≤–∞ –∑–∞–≤–µ—Ä–µ–Ω—ã':['–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ–±–º–µ–Ω'],

};

const TEAM = ['–ê—Ä–∏–Ω–∞','–ê–ª–∏–Ω–∞','–û–ª–µ–≥','–°—Ç–µ—Ñ–∞–Ω–∏','–ü–∞—É–ª–∞','‚Äî'];

const MONTHS = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

const SLOTS = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];

const AIMA_STATUSES = ['–ê–Ω–∞–ª–∏–∑','–ê–ø—Ä—É–≤','–ü–µ—á–∞—Ç—å','–î–æ–∑–∞–ø—Ä–æ—Å','–û—Ç–∫–∞–∑','–ó–∞–≤–µ—Ä—à–µ–Ω–æ'];

const VD_STATUSES = ['–ó–∞–ø–∏—Å–∞–Ω','–ü–æ–¥–∞—á–∞ —Å–¥–µ–ª–∞–Ω–∞','–í–∏–∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∞','–î–æ–∑–∞–ø—Ä–æ—Å','–û—Ç–∫–∞–∑','–ê–Ω–∞–ª–∏–∑','–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è','–ê–Ω–∞–ª–∏–∑ –õ–∏—Å—Å–∞–±–æ–Ω','–õ–∏—Å—Å–∞–±–æ–Ω —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç','–ï—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ, –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç'];

const COURT_STAGES = ['–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã','–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥ —Å–¥–µ–ª–∞–Ω–∞','‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞','–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω'];

const CIT_STAGES = ['–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã','–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä –ø–æ–ª—É—á–µ–Ω','‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–∞'];

const RIGHTS_STAGES = ['–î–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏–Ω—è—Ç—ã','–ü—Ä–∞–≤–∞ –∑–∞–≤–µ—Ä–µ–Ω—ã','–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','–ê–ø—Ä—É–≤ –ø–æ–ª—É—á–µ–Ω','–ó–∞–ø–∏—Å—å —Å–¥–µ–ª–∞–Ω–∞','–ì–æ—Ç–æ–≤–æ'];

const COURT_STATUSES  = ['–í –ø—Ä–æ—Ü–µ—Å—Å–µ','–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è','–°–ª—É—à–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ','–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ','–ê–ø–µ–ª–ª—è—Ü–∏—è','–ó–∞–≤–µ—Ä—à–µ–Ω–æ','–£—Å–ª–æ–≤–Ω—ã–π','–®—Ç—Ä–∞—Ñ','–ê—Ä–µ—Å—Ç'];

const CIT_STATUSES    = ['–í –æ–±—Ä–∞–±–æ—Ç–∫–µ','–ê–ø—Ä—É–≤','–û—Ç–∫–∞–∑','–î–æ–∑–∞–ø—Ä–æ—Å','–ó–∞–≤–µ—Ä—à–µ–Ω–æ','–ü—Ä–∏—Å—è–≥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞','–ü–∞—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤'];

const RIGHTS_STATUSES = ['–í –æ–±—Ä–∞–±–æ—Ç–∫–µ','–ü—Ä–∏–Ω—è—Ç–æ','–ê–ø—Ä—É–≤','–û—Ç–∫–∞–∑','–î–æ–∑–∞–ø—Ä–æ—Å','–ó–∞–≤–µ—Ä—à–µ–Ω–æ','–ü—Ä–∞–≤–∞ –≤—ã–¥–∞–Ω—ã'];

const KB_COLS = [

  {id:'–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç',label:'–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç',color:'var(--acc)'},

  {id:'–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω',label:'–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω',color:'var(--tea)'},

  {id:'–ê–∫—Ç–∏–≤–Ω—ã–π',label:'–ê–∫—Ç–∏–≤–Ω—ã–π',color:'var(--gre)'},

  {id:'–ó–∞–≤–µ—Ä—à—ë–Ω',label:'–ó–∞–≤–µ—Ä—à—ë–Ω',color:'var(--t3)'},

];

// ============================================================

// LOCAL DATA (fallback when API unavailable)

// ============================================================

let clients = [

  {id:'686695906',name:'Dmitrii Peshkov',tg:'@Peshkov_DV',phone:'89214101145',serviceType:'–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ',last:'2026-02-18',consulate:'09.03.2026',city:'–ú–æ—Å–∫–≤–∞',onboard:[true,true,false]},

  {id:'317375653',name:'Alex Filippov',tg:'@FeelWhy',phone:'351912983774',serviceType:'–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã)',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'–ó–∞–ø–∏—Å—å –≤ AIMA –ø–æ–ª—É—á–µ–Ω–∞',last:'2026-02-06',consulate:'',city:'',onboard:[true,true,true]},

  {id:'298813370',name:'Vladimir',tg:'@byFoxsmile',phone:'351929190179',serviceType:'–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'–ö–ª–∏–µ–Ω—Ç –≤ –ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏',last:'2026-02-18',consulate:'',city:'',onboard:[true,true,true]},

  {id:'305687618',name:'–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –î—É–±–∫–æ–≤',tg:'@vokdub',phone:'323496580',serviceType:'–°—É–¥',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',last:'2026-02-03',consulate:'25.11.2025',city:'–í–∏–∑–µ—É',onboard:[true,true,true]},

  {id:'497330118',name:'–ù–∞–¥–µ–∂–¥–∞ –î.',tg:'@minadeeen',phone:'',serviceType:'–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞–Ω—ã –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ',last:'2026-01-28',consulate:'',city:'',onboard:[true,true,true]},

  {id:'330739229',name:'Elena B',tg:'@elena_903b',phone:'',serviceType:'–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –í–∏–∑–∞ D',last:'2026-02-09',consulate:'',city:'',onboard:[true,true,true]},

  {id:'5652671788',name:'MigrAll Portugal',tg:'@MigrAllPT',phone:'926964093',serviceType:'',stage:'–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç',substage:'',last:'2026-02-18',consulate:'',city:'',onboard:[false,false,false]},

  {id:'310067905',name:'Alina',tg:'@alinateuvo',phone:'',serviceType:'–ü—Ä–∞–≤–∞',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'–î–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏–Ω—è—Ç—ã',last:'2025-12-03',consulate:'',city:'',onboard:[true,true,true]},

  {id:'323305057',name:'Pavel Dyagilev',tg:'@Pdyagilev',phone:'',serviceType:'–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)',stage:'–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω',substage:'',last:'2025-11-19',consulate:'',city:'',onboard:[true,true,false]},

  {id:'959731329',name:'marspr1v3t',tg:'@marsprivet',phone:'',serviceType:'–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)',stage:'–ê–∫—Ç–∏–≤–Ω—ã–π',substage:'–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞–Ω—ã –≤ –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤–æ',last:'2026-02-06',consulate:'',city:'',onboard:[true,true,true]},

];

let statuses = [

  {num:'385',name:'TIMUR VALEEV',nipc:'5370563',dob:'15/10/1991',pass:'75 8187317',status:'–ü–µ—á–∞—Ç—å',date:'09/02/2026',sec:'–û–ë–©–ò–ï'},

  {num:'808',name:'GALINA RODZIONOVA',nipc:'5691535',dob:'',pass:'',status:'–ê–ø—Ä—É–≤',date:'30/01/2026',sec:'–û–ë–©–ò–ï'},

  {num:'328',name:'PETR EGOROV',nipc:'6244911',dob:'23/12/2003',pass:'',status:'–ê–Ω–∞–ª–∏–∑',date:'27/01/2026',sec:'–û–ë–©–ò–ï'},

  {num:'248',name:'ALEKSEI ARTAMONOV',nipc:'6714018',dob:'29/02/1984',pass:'',status:'–ê–Ω–∞–ª–∏–∑',date:'27/01/2026',sec:'–û–ë–©–ò–ï'},

  {num:'438',name:'VIACHESLAV PEROV',nipc:'7042547',dob:'18/01/1985',pass:'',status:'–ê–Ω–∞–ª–∏–∑',date:'27/01/2026',sec:'–û–ë–©–ò–ï'},

  {num:'366',name:'ALISA GREBENSHCHIKOVA',nipc:'6876032',dob:'12/06/1978',pass:'',status:'–ê–Ω–∞–ª–∏–∑',date:'27/01/2026',sec:'–û–ë–©–ò–ï'},

  {num:'412',name:'IULIIA BEBNEVA',nipc:'6704257',dob:'05/10/1988',pass:'76 7206171',status:'–ê–Ω–∞–ª–∏–∑',date:'27/01/2026',sec:'–û–ë–©–ò–ï'},

  {num:'634',name:'ALEKSANDR BANNIKOV',nipc:'6738644',dob:'24/11/1989',pass:'',status:'–ê–ø—Ä—É–≤',date:'09/02/2026',sec:'–û–ë–©–ò–ï'},

  {num:'352',name:'PETR BARANNIKOV',nipc:'5768617',dob:'12/05/1981',pass:'',status:'–ê–Ω–∞–ª–∏–∑',date:'09/02/2026',sec:'–û–ë–©–ò–ï'},

  {num:'326',name:'ZLATA LAUD',nipc:'6738794',dob:'05/05/1990',pass:'774436316',status:'–ê–Ω–∞–ª–∏–∑',date:'02/02/2026',sec:'–û–ë–©–ò–ï'},

  {num:'492',name:'ALEKSANDR DUBKOV',nipc:'6990534',dob:'25/07/1997',pass:'75 9304459',status:'–ê–Ω–∞–ª–∏–∑',date:'09/02/2026',sec:'–û–ë–©–ò–ï'},

  {num:'770',name:'SIARHEI DZEMIKHAU',nipc:'MI 4993389274',dob:'08/07/1995',pass:'MC3274835',status:'–ê–Ω–∞–ª–∏–∑',date:'04/02/2026',sec:'–ú–ê–ù–ò–§–ï–°–¢'},

  {num:'653',name:'ANASTASIIA MURASHOVA',nipc:'MI: 4935931915',dob:'19/01/1995',pass:'55 1904015',status:'–ê–Ω–∞–ª–∏–∑',date:'29/01/2026',sec:'–ú–ê–ù–ò–§–ï–°–¢'},

  {num:'313',name:'EVGENIIA KONDRUSEVA',nipc:'MI: 763111225',dob:'05/05/1983',pass:'',status:'–ê–Ω–∞–ª–∏–∑',date:'27/01/2026',sec:'–ú–ê–ù–ò–§–ï–°–¢'},

];

let visaD = [

  {num:'585',name:'MARINA TASHCHILINA',type:'DN',dob:'24/12/1988',pass:'76 2330746',status:'–í–∏–∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∞',date:'',updated:'',city:'–ú–æ—Å–∫–≤–∞',comment:'–†–µ–±–µ–Ω–æ–∫ –¥–æ–ª–∂–µ–Ω —Ä–æ–¥–∏—Ç—å—Å—è'},

  {num:'210',name:'VASILISA NICHIPOR',type:'DN',dob:'',pass:'',status:'–í–∏–∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∞',date:'',updated:'',city:'–ú–æ—Å–∫–≤–∞',comment:''},

  {num:'654',name:'ILIA ORLOV',type:'D7',dob:'02/10/1977',pass:'',status:'–í–∏–∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∞',date:'',updated:'',city:'–ú–æ—Å–∫–≤–∞',comment:''},

  {num:'376',name:'ELENA BONIUKHOVA',type:'DN',dob:'02/04/1992',pass:'765661132',status:'–î–æ–∑–∞–ø—Ä–æ—Å',date:'',updated:'',city:'–ú–æ—Å–∫–≤–∞',comment:''},

  {num:'472',name:'KONSTANTIN SMIRNOV',type:'DN',dob:'12/06/1978',pass:'',status:'–ê–Ω–∞–ª–∏–∑ –õ–∏—Å—Å–∞–±–æ–Ω',date:'12/09/2025',updated:'',city:'–õ–∏—Å—Å–∞–±–æ–Ω',comment:''},

  {num:'580',name:'TATIANA TIMOSHENKO',type:'DN',dob:'07/08/1980',pass:'',status:'–õ–∏—Å—Å–∞–±–æ–Ω —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç',date:'25/11/2025',updated:'',city:'–õ–∏—Å—Å–∞–±–æ–Ω',comment:''},

  {num:'419',name:'ANDREY SHIRIAEV',type:'DN',dob:'03/02/1992',pass:'55 1408779',status:'–ï—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ, –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç',date:'15/01/2026',updated:'',city:'',comment:''},

  {num:'839',name:'DANIL ZHILIAEV',type:'D3',dob:'',pass:'',status:'–ü–æ–¥–∞—á–∞ 02/02',date:'02/02/2026',updated:'',city:'–ë–∞—Ä—Å–µ–ª–æ–Ω–∞',comment:''},

  {num:'392',name:'DMITRII PESHKOV',type:'D7',dob:'',pass:'',status:'–ó–∞–ø–∏—Å—å 09/03',date:'09/03/2026',updated:'',city:'–ú–æ—Å–∫–≤–∞',comment:''},

  {num:'742',name:'EVGENII VLASOV',type:'DN',dob:'',pass:'',status:'–ü–æ–¥–∞—á–∞ 02/03',date:'02/03/2026',updated:'',city:'–ú–æ—Å–∫–≤–∞',comment:''},

  {num:'413',name:'VLADA DANILINA',type:'DN',dob:'',pass:'',status:'–ü–æ–¥–∞—á–∞ 23/01',date:'23/01/2026',updated:'',city:'Coimbra',comment:'–û–ª–µ–≥ –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥ + –Ω—É–∂–µ–Ω NISS'},

];

let courts = [

  {num:'100',name:'LILIA KOZLOVA',article:'98.2',date:'11/02/2026',place:'Braga',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:'–Ω–µ –≤ –±—Ä–∞–∫–µ! –î–æ–∫–∏ ‚Üí –∞–¥–≤–æ–∫–∞—Ç—É. –°–¥–µ–ª–∞—Ç—å NISS'},

  {num:'559',name:'AYK EMINYAN',article:'90.2',date:'19/02/2026',place:'Espinho',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:'App file –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É'},

  {num:'338',name:'VLADIMIR GENGURIAN',article:'90.2',date:'19/02/2026',place:'Aveiro',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:'–∂–¥–µ–º –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—é —Å —Ä–∞–±–æ—Ç—ã'},

  {num:'118',name:'DARIA MANAEVA',article:'98.2',date:'19/02/2026',place:'Lisboa',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:'–ü–æ –ø–æ—Ä—Ç–∞–ª—É. –î–æ–∫—É–º–µ–Ω—Ç—ã ‚Üí –ü–∞—É–ª–µ'},

  {num:'456',name:'MARINA ANISIMOVA',article:'15',date:'19/02/2026',place:'Viseu',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:'App file ‚Üí –∫–ª–∏–µ–Ω—Ç—É'},

  {num:'591',name:'OLHA LYSENKO',article:'90.2',date:'26/02/2026',place:'Lisboa I',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:'–û—Ç–¥–∞—Ç—å –ê—Ä–∏–Ω–µ'},

  {num:'438',name:'VIACHESLAV PEROV',article:'90.2',date:'19/01/2026',place:'AIMA Porto',stage:'–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥ —Å–¥–µ–ª–∞–Ω–∞',status:'–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è',updated:'',comment:'–æ–ø–µ—á–∞—Ç–∫–∞ –≤ —Ñ–∞–º–∏–ª–∏–∏ PERON'},

  {num:'308',name:'KIRILL RASSKAZOV',article:'98.2',date:'26/01/2026',place:'AIMA VILA REAL',stage:'–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥ —Å–¥–µ–ª–∞–Ω–∞',status:'–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è',updated:'',comment:''},

  {num:'541',name:'ELENA SHILEIN',article:'91',date:'20/01/2026',place:'Lisboa II',stage:'‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞',status:'–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è',updated:'',comment:'–Ω—É–∂–µ–Ω NISS??'},

  {num:'329',name:'PETR EGOROV',article:'90.2',date:'16/12/2025',place:'Guarda',stage:'‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞',status:'–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è',updated:'',comment:''},

  {num:'549',name:'VIKTORIIA BELIAEVA',article:'90.2',date:'17/12/2025',place:'Aveiro',stage:'–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥ —Å–¥–µ–ª–∞–Ω–∞',status:'–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è',updated:'',comment:''},

];

let citizenship = [];

let rights = [];

let meetings = [

  {date:'13.02.2026',time:'10:00',name:'–û–ª—å–≥–∞ –ö–æ–≤–∞–ª—å—Å–∫–∞—è',tg:'@okovalskaya',status:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',meet:'https://meet.google.com/yjh-strx-wio'},

  {date:'13.02.2026',time:'12:00',name:'Marina Tashchilina',tg:'@marina_universe',status:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',meet:'https://meet.google.com/gwd-drft-pnz'},

  {date:'16.02.2026',time:'16:00',name:'–û–ª—å–≥–∞ –°–º–∏—Ä–Ω–æ–≤–∞',tg:'@alekssachh',status:'–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',meet:''},

  {date:'18.02.2026',time:'10:00',name:'–ú–∞—Ä–∏–Ω–∞',tg:'@marina_interior_kz',status:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',meet:'https://meet.google.com/tny-ttuj-wcu'},

  {date:'18.02.2026',time:'16:00',name:'Elvira Shaykhulova',tg:'@elvirash',status:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',meet:'https://meet.google.com/oqe-uypa-fuf'},

  {date:'19.02.2026',time:'11:00',name:'–ß–µ—Ä–µ—à–Ω–µ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä',tg:'@oxotnick85',status:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',meet:''},

  {date:'19.02.2026',time:'14:00',name:'–°–∞–≤–µ–ª–∏–π –ö–ª–∏–º–µ–Ω–∫–æ–≤',tg:'@OGSaveliy',status:'–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',meet:''},

  {date:'20.02.2026',time:'10:00',name:'–°—Ç–µ–ø–∞–Ω–µ–Ω–∫–æ –Æ—Ä–∏–π',tg:'@A320_Captain',status:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',meet:''},

  {date:'25.02.2026',time:'10:00',name:'–í–ª–∞—Å–æ–≤ –ï–≤–≥–µ–Ω–∏–π',tg:'@evgnv',status:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',meet:''},

];

const CAL_EVENTS = {

  '2026-02-13':[{type:'meet',label:'10:00 –ö–æ–≤–∞–ª—å—Å–∫–∞—è',detail:'–û–ª—å–≥–∞ –ö–æ–≤–∞–ª—å—Å–∫–∞—è ¬∑ @okovalskaya',time:'10:00'}],

  '2026-02-18':[{type:'meet',label:'10:00 –ú–∞—Ä–∏–Ω–∞',detail:'–ú–∞—Ä–∏–Ω–∞ ¬∑ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è',time:'10:00'},{type:'meet',label:'16:00 Shaykhulova',detail:'Elvira Shaykhulova',time:'16:00'}],

  '2026-02-19':[{type:'meet',label:'11:00 –ß–µ—Ä–µ—à–Ω–µ–≤',detail:'–ß–µ—Ä–µ—à–Ω–µ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä',time:'11:00'},{type:'court',label:'–°—É–¥—ã: Eminyan, Gengurian',detail:'90.2, 98.2 ¬∑ Espinho/Aveiro',time:''}],

  '2026-02-20':[{type:'meet',label:'10:00 –°—Ç–µ–ø–∞–Ω–µ–Ω–∫–æ',detail:'–°—Ç–µ–ø–∞–Ω–µ–Ω–∫–æ –Æ—Ä–∏–π',time:'10:00'}],

  '2026-02-26':[{type:'court',label:'–°—É–¥: Lysenko 90.2',detail:'OLHA LYSENKO ¬∑ Lisboa I',time:'14:30'}],

};

let tasks = [

  {id:'t001',text:'541 ‚Äî –ø–∏—Å—å–º–æ –¥–ª—è –∑–∞–ø–∏—Å–∏ –ø–æ 91 —Å—Ç–∞—Ç—å–µ',client:'541',assignee:'–ê–ª–∏–Ω–∞',prio:'high',stage:'todo',due:'2026-02-20',created:'2026-02-18',cmts:[{a:'–ê—Ä–∏–Ω–∞',d:'18.02.2026',t:'–ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É'}]},

  {id:'t002',text:'793 ‚Äî –ø–∏—Å—å–º–æ –≤ AIMA –Ω–∞ –æ—Ç—Ü–∞',client:'793',assignee:'–û–ª–µ–≥',prio:'high',stage:'todo',due:'2026-02-19',created:'2026-02-18',cmts:[]},

  {id:'t003',text:'770 ‚Äî –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è –Ω–∞ –ª–µ–Ω–¥–ª–æ—Ä–¥–∞',client:'770',assignee:'–ê–ª–∏–Ω–∞',prio:'mid',stage:'todo',due:'2026-02-21',created:'2026-02-17',cmts:[]},

  {id:'t004',text:'438 ‚Äî NISS Finan –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ',client:'438',assignee:'–ê–ª–∏–Ω–∞',prio:'mid',stage:'todo',due:'2026-02-25',created:'2026-02-17',cmts:[]},

  {id:'t005',text:'545 ‚Äî –∞–ø–µ–ª–ª—è—Ü–∏—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ü–∞—É–ª–µ',client:'545',assignee:'–û–ª–µ–≥',prio:'high',stage:'inprogress',due:'2026-02-18',created:'2026-02-15',cmts:[{a:'–û–ª–µ–≥',d:'17.02.2026',t:'–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª —á–µ—Ä–Ω–æ–≤–∏–∫, –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞'}]},

  {id:'t006',text:'689 ‚Äî –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è –ü–∞—É–ª–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å',client:'689',assignee:'–ê—Ä–∏–Ω–∞',prio:'high',stage:'inprogress',due:'2026-02-18',created:'2026-02-16',cmts:[]},

  {id:'t007',text:'793 ‚Äî —Å—É–¥ (90.2) –ø–æ–¥–∞—á–∞',client:'793',assignee:'–û–ª–µ–≥',prio:'high',stage:'inprogress',due:'2026-02-19',created:'2026-02-16',cmts:[]},

  {id:'t008',text:'549 ‚Äî NISS –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ',client:'549',assignee:'–ê–ª–∏–Ω–∞',prio:'mid',stage:'inprogress',due:'2026-02-22',created:'2026-02-14',cmts:[]},

  {id:'t009',text:'770 ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—á',client:'770',assignee:'–ê–ª–∏–Ω–∞',prio:'low',stage:'done',due:'2026-02-15',created:'2026-02-10',cmts:[]},

  {id:'t010',text:'793 ‚Äî —Ä–∞–±–æ—á–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≥–æ—Ç–æ–≤',client:'793',assignee:'–û–ª–µ–≥',prio:'low',stage:'done',due:'2026-02-14',created:'2026-02-10',cmts:[]},

];

// ============================================================

// HELPERS

// ============================================================

function g(id){return document.getElementById(id)}

function uid(){return 't'+Date.now().toString(36)+Math.random().toString(36).slice(2,5)}

function today(){return new Date().toISOString().split('T')[0]}

function nowDMY(){const d=new Date();return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`}

function parseDMY(s){if(!s)return new Date(0);const p=s.split('/');if(p.length===3)return new Date(+p[2],+p[1]-1,+p[0]);if(s.includes('.')){const p2=s.split('.');return new Date(+p2[2],+p2[1]-1,+p2[0]);}return new Date(s);}

function badgeClass(s){

  const map={

    '–ê–ø—Ä—É–≤':'gre','–í–∏–∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∞':'gre','–ì–æ—Ç–æ–≤–æ':'gre','–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω':'gre','–ê–ø—Ä—É–≤ –ø–æ–ª—É—á–µ–Ω':'gre','–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ':'gre','–ó–∞–≤–µ—Ä—à–µ–Ω–æ':'gre',

    '–ê–Ω–∞–ª–∏–∑':'yel','–í –ø—Ä–æ—Ü–µ—Å—Å–µ':'yel','–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è':'yel','–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è':'yel','–õ–∏—Å—Å–∞–±–æ–Ω —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç':'yel','–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è':'yel','–ü–æ–¥–∞—á–∞ –¥–∞—Ç–∞':'yel',

    '–ü–µ—á–∞—Ç—å':'pur','‚Üí':'pur','–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä –ø–æ–ª—É—á–µ–Ω':'pur',

    '–î–æ–∑–∞–ø—Ä–æ—Å':'ora','–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è':'ora','–ï—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ':'ora',

    '–û—Ç–∫–∞–∑':'red',

    '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç':'blu','–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω':'tea','–ê–∫—Ç–∏–≤–Ω—ã–π':'gre','–ó–∞–≤–µ—Ä—à—ë–Ω':'gry',

  };

  if(!s)return 'gry';

  const k=Object.keys(map).find(k=>s.includes(k));

  return k?map[k]:'gry';

}

function bdg(s,extra=''){return `<span class="bdg ${badgeClass(s)} ${extra}">${s||'‚Äî'}</span>`;}

function svcBdg(svc){

  const c=SVC_COLORS[svc]||'var(--t3)';

  return svc?`<span class="bdg" style="background:color-mix(in srgb,${c} 12%,white);color:${c};border:1px solid color-mix(in srgb,${c} 25%,white)">${svc}</span>`:'<span class="bdg gry">‚Äî</span>';

}

function fmtDate(d){return d||'‚Äî'}

function showLoading(on){

  const el=g('loading-bar');

  if(on){el.style.width='0';el.style.transition='none';setTimeout(()=>{el.style.transition='width .8s';el.style.width='70%';},10);}

  else{el.style.width='100%';setTimeout(()=>{el.style.width='0';el.style.transition='none';},400);}

}

// ============================================================

// MOBILE SIDEBAR

// ============================================================

function openSb(){g('sidebar').classList.add('open');g('sb-overlay').classList.add('open');}

function closeSb(){g('sidebar').classList.remove('open');g('sb-overlay').classList.remove('open');}

// ============================================================

// NAVIGATION

// ============================================================

const VIEW_TITLES = {dashboard:'–î–∞—à–±–æ—Ä–¥',clients:'–ö–ª–∏–µ–Ω—Ç—ã',kanban:'Kanban Pipeline',aima:'–ü—Ä–æ–≤–µ—Ä–∫–∏ AIMA',visad:'–í–∏–∑–∞ D',courts:'–°—É–¥—ã',citizenship:'–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ',rights:'–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞',schedule:'–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á',calendar:'–ö–æ–º–∞–Ω–¥–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å',tasks:'–ó–∞–¥–∞—á–∏',integration:'API / –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏'};

function showView(id,el){

  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));

  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));

  g('view-'+id).classList.add('active');

  if(el){el.classList.add('active');}else{document.querySelectorAll('.ni').forEach(n=>{if(n.onclick&&n.onclick.toString().includes("'"+id+"'"))n.classList.add('active');});}

  g('pg-title').textContent=VIEW_TITLES[id]||id;

  closeSb();

  if(id==='calendar')renderCal();

  if(id==='schedule'){renderSchedMini();renderMeetings(meetings);}

}

function handleSearch(q){

  if(!q.trim()){renderClients(clients);return;}

  const f=q.toLowerCase();

  const res=clients.filter(c=>c.name.toLowerCase().includes(f)||c.tg.toLowerCase().includes(f)||c.id.includes(q));

  renderClients(res);

  showView('clients');

}

// ============================================================

// SYNC

// ============================================================

async function doSync(){

  const ic=g('sync-spin');

  let ang=0;const iv=setInterval(()=>{ic.style.transform=`rotate(${ang+=20}deg)`;},40);

  showLoading(true);

  

  const results = await Promise.all([

    apiFetch('/clients'),

    apiFetch('/statuses'),

    apiFetch('/courts'),

    apiFetch('/schedule'),

    apiFetch('/visad'),

    apiFetch('/citizenship'),

    apiFetch('/rights'),

  ]);

  

  API_ONLINE = results.some(r=>r!==null);

  if(results[0])clients=results[0];

  if(results[1])statuses=results[1];

  if(results[2])courts=results[2];

  if(results[3])meetings=results[3];

  if(results[4])visaD=results[4];

  if(results[5])citizenship=results[5];

  if(results[6])rights=results[6];

  

  clearInterval(iv);ic.style.transform='';

  showLoading(false);

  

  const dot=g('api-dot');const txt=g('api-status-txt');

  if(API_ONLINE){dot.className='api-dot';txt.textContent='–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ¬∑ '+new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});}

  else{dot.className='api-dot warn';txt.textContent='API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';}

  

  renderAll();

  updateIntStatus(API_ONLINE);

}

function updateIntStatus(ok){

  ['crm','aima','courts','sched','subs'].forEach(k=>{

    const d=g('ds-'+k+'-dot');const t=g('ds-'+k+'-txt');

    if(d)d.className='api-dot '+(ok?'ok':'w');

    if(t)t.textContent=ok?'–ü–æ–¥–∫–ª—é—á–µ–Ω–æ':'–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';

  });

}

// ============================================================

// DASHBOARD

// ============================================================

let taskPeriod='day';

function setTaskPeriod(p,el){

  taskPeriod=p;

  document.querySelectorAll('.ts-fc').forEach(c=>c.classList.remove('active'));

  el.classList.add('active');

  renderTaskStats();

}

function renderTaskStats(){

  const now=new Date();let start;

  if(taskPeriod==='day'){start=new Date(now.getFullYear(),now.getMonth(),now.getDate());}

  else if(taskPeriod==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay()+1);d.setHours(0,0,0,0);start=d;}

  else if(taskPeriod==='month'){start=new Date(now.getFullYear(),now.getMonth(),1);}

  else{start=new Date(0);}

  

  const inRange=getVisibleTasks().filter(t=>{if(!t.created)return true;return new Date(t.created)>=start;});

  const tot=inRange.length;

  const prog=inRange.filter(t=>t.stage==='inprogress').length;

  const done=inRange.filter(t=>t.stage==='done').length;

  const over=inRange.filter(t=>t.stage!=='done'&&t.due&&new Date(t.due)<now).length;

  

  g('ts-tot').textContent=tot;g('ts-prog').textContent=prog;g('ts-done').textContent=done;g('ts-over').textContent=over;

  g('bdg-tasks').textContent=tasks.filter(t=>t.stage!=='done').length;

}

function renderDash(){

  // KPI

  g('kpi-total').textContent=clients.length;

  g('kpi-review').textContent=statuses.filter(s=>s.status==='–ê–Ω–∞–ª–∏–∑').length;

  g('kpi-approved').textContent=statuses.filter(s=>s.status==='–ê–ø—Ä—É–≤').length;

  const todayStr=new Date().toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'}).replace(/\//g,'.');

  const todayMeets=meetings.filter(m=>m.date===todayStr);

  g('kpi-meets').textContent=todayMeets.length;

  g('kpi-meets-s').textContent=todayStr;

  g('bdg-aima').textContent=statuses.length;

  

  // Update scope based on current user

  const myTasks=getVisibleTasks();

  const openMyTasks=myTasks.filter(t=>t.stage!=='done');

  g('bdg-tasks').textContent=openMyTasks.length;

  

  // Meets

  const upcoming=meetings.filter(m=>parseDMY(m.date)>=new Date(new Date().setHours(0,0,0,0))).slice(0,5);

  g('dash-meets').innerHTML=upcoming.map(m=>`<div class="meet-row"><div class="meet-t">${m.date} ¬∑ ${m.time}</div><div class="meet-n">${m.name}</div>${bdg(m.status)}</div>`).join('')||'<div class="cal-empty">–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –≤—Å—Ç—Ä–µ—á</div>';

  

  // AIMA oldest

  const aimaSorted=[...statuses].sort((a,b)=>parseDMY(a.date)-parseDMY(b.date));

  g('dash-aima').innerHTML=aimaSorted.slice(0,5).map(s=>`<div class="stat-row"><div class="stat-num">${s.num}</div><div class="stat-name">${s.name}</div><div class="stat-date">${s.date}</div>${bdg(s.status)}</div>`).join('');

  

  // My tasks panel

  const myOpenTasks=getVisibleTasks().filter(t=>t.stage!=='done');

  const titleEl=g('dash-my-tasks-title');

  const cntEl=g('dash-my-tasks-cnt');

  if(titleEl) titleEl.textContent=currentUser?(currentUser.role==='admin'||currentUser.canSeeAll?'–í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏':'–ú–æ–∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏'):'–û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏';

  if(cntEl) cntEl.textContent=myOpenTasks.length;

  g('dash-my-tasks').innerHTML=myOpenTasks.slice(0,6).map(t=>`

    <div class="stat-row" onclick="showView('tasks',null)" style="cursor:pointer">

      <div class="pdot ${t.prio}" style="width:7px;height:7px;flex-shrink:0"></div>

      <div class="stat-name">${t.text}</div>

      <div class="stat-date">${t.due||'‚Äî'}</div>

      ${bdg(t.stage==='todo'?'–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é':t.stage==='inprogress'?'–í –ø—Ä–æ—Ü–µ—Å—Å–µ':'–í—ã–ø–æ–ª–Ω–µ–Ω–æ')}

    </div>`).join('')||'<div class="cal-empty">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á üéâ</div>';

  // Courts oldest

  const courtsSorted=[...courts].sort((a,b)=>parseDMY(a.date)-parseDMY(b.date));

  g('dash-courts').innerHTML=courtsSorted.slice(0,5).map(c=>`<div class="stat-row"><div class="stat-num" style="color:var(--pur)">${c.num}</div><div class="stat-name">${c.name}</div><div class="stat-date">${c.date}</div><span class="bdg pur">${c.article}</span></div>`).join('')||'<div class="cal-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

  

  // Citizenship

  g('dash-cit').innerHTML=citizenship.length?citizenship.slice(0,4).map(c=>`<div class="stat-row"><div class="stat-num" style="color:var(--ora)">${c.num}</div><div class="stat-name">${c.name}</div>${bdg(c.status)}</div>`).join(''):'<div class="cal-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

  

  // Rights  

  g('dash-rights').innerHTML=rights.length?rights.slice(0,4).map(r=>`<div class="stat-row"><div class="stat-num" style="color:var(--gre)">${r.num}</div><div class="stat-name">${r.name}</div>${bdg(r.status)}</div>`).join(''):'<div class="cal-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

  

  renderTaskStats();

}

// ============================================================

// CLIENTS

// ============================================================

function renderClients(data){

  g('clients-tbody').innerHTML=(data||clients).map(c=>`

    <tr onclick="openClientModal('${c.id}')">

      <td class="mono" style="color:var(--acc)">${c.id}</td>

      <td style="font-weight:600">${c.name}</td>

      <td class="mono" style="color:var(--acc)">${c.tg}</td>

      <td>${svcBdg(c.serviceType)}</td>

      <td>${bdg(c.stage)}</td>

      <td style="font-size:10.5px;color:var(--t2);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.substage||'‚Äî'}</td>

      <td class="mono" style="color:var(--t3)">${c.last||'‚Äî'}</td>

    </tr>`).join('');

}

// ============================================================

// KANBAN

// ============================================================

let kbFilter='all';

function initKbChips(){

  const labels={'all':'–í—Å–µ','–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)':'–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª','–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã)':'–í–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã','–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –í–ù–ñ':'–ü—Ä–æ–¥–ª–µ–Ω–∏–µ','–°—É–¥':'–°—É–¥','–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ':'–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ','–ü—Ä–∞–≤–∞':'–ü—Ä–∞–≤–∞','–†–∞–∑–æ–≤–∞—è —É—Å–ª—É–≥–∞':'–†–∞–∑–æ–≤–∞—è'};

  g('kb-chips').innerHTML=['all',...SVC_TYPES].map(s=>`<div class="chip ${s==='all'?'active':''}" onclick="setKbFilter('${s}',this)">${labels[s]||s}</div>`).join('');

}

function setKbFilter(f,el){kbFilter=f;document.querySelectorAll('#kb-chips .chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderKanban();}

function renderKanban(){

  const data=kbFilter==='all'?clients:clients.filter(c=>c.serviceType===kbFilter);

  g('kb-board').innerHTML=KB_COLS.map(col=>{

    const cards=data.filter(c=>c.stage===col.id);

    return`<div class="kb-col">

      <div class="kb-hdr"><div class="kb-dot" style="background:${col.color}"></div><div class="kb-lbl" style="color:${col.color}">${col.label}</div><div class="kb-cnt">${cards.length}</div></div>

      <div class="kb-cards">${cards.map(c=>renderKCard(c)).join('')}</div>

      <div class="kb-add" onclick="openAddClientModal('${col.id}')">+ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</div>

    </div>`;

  }).join('');

}

function renderKCard(c){

  const openTasks=tasks.filter(t=>t.client===c.id&&t.stage!=='done').length;

  const sc=SVC_COLORS[c.serviceType]||'var(--t3)';

  return`<div class="kcard" onclick="openClientModal('${c.id}')">

    <div class="kcard-id">${c.id}</div>

    <div class="kcard-name">${c.name}</div>

    ${c.serviceType?`<div class="kcard-svc" style="color:${sc}">${c.serviceType}</div>`:''}

    ${c.substage?`<div class="kcard-sub">${c.substage}</div>`:''}

    ${c.stage==='–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç'?`<div style="font-size:8.5px;color:var(--t3);margin-top:2px">–û–Ω–±–æ—Ä–¥–∏–Ω–≥: ${(c.onboard||[]).filter(Boolean).length}/3</div>`:''}

    <div class="kcard-ft">

      <div class="kcard-tg">${c.tg}</div>

      ${openTasks>0?`<span class="bdg ora">${openTasks} –∑–∞–¥–∞—á</span>`:''}

    </div>

  </div>`;

}

// ============================================================

// CLIENT MODAL

// ============================================================

function openClientModal(cid){

  const c=clients.find(x=>x.id===cid);if(!c)return;

  const subs=SUBSTAGES[c.serviceType]||[];

  const obl=['–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±—Ä–∏—Ñ','–ü—Ä–∏—Å–≤–æ–∏—Ç—å –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞','–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'];

  const ctasks=tasks.filter(t=>t.client===cid);

  openModal(`

    <div class="mhdr">

      <div>

        <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t3)">ID: ${c.id}</div>

        <div style="font-family:'Unbounded',sans-serif;font-size:18px;font-weight:700;margin-top:2px">${c.name}</div>

        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:6px">${svcBdg(c.serviceType)} ${bdg(c.stage)}</div>

      </div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><span class="mfl">Telegram</span><div style="color:var(--acc);font-size:12px;font-weight:600">${c.tg}</div></div>

      <div class="mf"><span class="mfl">–¢–µ–ª–µ—Ñ–æ–Ω</span><div class="mono" style="font-size:11px">${c.phone||'‚Äî'}</div></div>

      <div class="mf"><span class="mfl">–ü–æ–¥–∞—á–∞ –∫–æ–Ω—Å.</span><div style="color:var(--yel);font-size:11px;font-weight:600">${c.consulate||'‚Äî'}</div></div>

      <div class="mf"><span class="mfl">–ì–æ—Ä–æ–¥</span><div style="font-size:11px">${c.city||'‚Äî'}</div></div>

    </div>

    <hr class="mdiv">

    

    ${c.stage==='–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç'?`

    <div class="msec">

      <div class="msl">–û–Ω–±–æ—Ä–¥–∏–Ω–≥-—á–µ–∫–ª–∏—Å—Ç</div>

      <div class="ob-list">

        ${obl.map((it,i)=>`<div class="ob-item ${(c.onboard||[])[i]?'done':''}" id="obi-${i}">

          <input type="checkbox" ${(c.onboard||[])[i]?'checked':''} onchange="toggleOnboard('${cid}',${i},this.checked)" id="obcb-${i}">

          <label for="obcb-${i}">${it}</label>

        </div>`).join('')}

      </div>

      <button class="btn btn-p btn-sm" style="margin-top:8px" onclick="doActivateClient('${cid}')">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ –ê–∫—Ç–∏–≤–Ω—ã–π ‚Üí</button>

    </div>`:''}

    

    ${c.stage==='–ê–∫—Ç–∏–≤–Ω—ã–π'&&subs.length>0?`

    <div class="msec">

      <div class="msl">–≠—Ç–∞–ø—ã ‚Äî ${c.serviceType}</div>

      <div class="pipe-steps">

        ${subs.map((s,i)=>{

          const idx=subs.indexOf(c.substage);

          const cls=c.substage===s?'active':idx>i?'done':'';

          return`<div class="ps-b ${cls}" onclick="setSubstage('${cid}','${s}')">${s}</div>${i<subs.length-1?'<span class="ps-arr">‚Ä∫</span>':''}`;

        }).join('')}

      </div>

    </div>`:''}

    

    <div class="msec">

      <div class="msl" style="display:flex;align-items:center;justify-content:space-between">

        <span>–ó–∞–¥–∞—á–∏ (${ctasks.length})</span>

        <button class="btn btn-g btn-xs" onclick="closeModal();openAddTaskModal('todo','${cid}')">+ –∑–∞–¥–∞—á–∞</button>

      </div>

      <div style="display:flex;flex-direction:column;gap:4px;max-height:120px;overflow-y:auto">

        ${ctasks.map(t=>`<div style="background:var(--s2);border-radius:5px;padding:6px 9px;border-left:3px solid ${t.prio==='high'?'var(--red)':t.prio==='mid'?'var(--yel)':'var(--t4)'}">

          <div style="font-size:10px;font-weight:500">${t.text}</div>

          <div style="font-size:8.5px;color:var(--t3);margin-top:2px">${bdg(t.stage)} ¬∑ ${t.assignee||'‚Äî'} ¬∑ ${t.due||'‚Äî'}</div>

        </div>`).join('')}

        ${ctasks.length===0?'<div style="color:var(--t3);font-size:10px;padding:4px">–ù–µ—Ç –∑–∞–¥–∞—á</div>':''}

      </div>

    </div>

    

    <div class="msec">

      <div class="msl">–ò–∑–º–µ–Ω–∏—Ç—å —ç—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏</div>

      <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">

        <select class="ms" id="cs-stage" style="max-width:200px">

          ${KB_COLS.map(k=>`<option value="${k.id}" ${c.stage===k.id?'selected':''}>${k.label}</option>`).join('')}

        </select>

        <button class="btn btn-p btn-sm" onclick="applyClientStage('${cid}')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>

      </div>

    </div>

  `,'wide');

}

function toggleOnboard(cid,i,v){

  const c=clients.find(x=>x.id===cid);if(!c)return;

  if(!c.onboard)c.onboard=[false,false,false];

  c.onboard[i]=v;

  const el=g('obi-'+i);if(el)el.className='ob-item'+(v?' done':'');

}

function doActivateClient(cid){

  closeModal();

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">–¢–∏–ø —É—Å–ª—É–≥–∏</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="msec">

      <label class="mfl">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å–ª—É–≥–∏ *</label>

      <select class="ms" id="act-svc" onchange="toggleCustomSvcInput(this.value)">

        ${SVC_TYPES.map(s=>`<option>${s}</option>`).join('')}

        <option value="__custom__">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é...</option>

      </select>

    </div>

    <div id="custom-svc-wrap" style="display:none;margin-top:8px">

      <label class="mfl">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏</label>

      <input class="mi" id="custom-svc-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏">

    </div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="confirmActivate('${cid}')">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å ‚Üí</button>

    </div>`,'narrow');

}

function toggleCustomSvcInput(v){g('custom-svc-wrap').style.display=v==='__custom__'?'block':'none';}

async function confirmActivate(cid){

  const c=clients.find(x=>x.id===cid);if(!c)return;

  let type=g('act-svc').value;

  if(type==='__custom__')type=g('custom-svc-name').value||'–†–∞–∑–æ–≤–∞—è —É—Å–ª—É–≥–∞';

  c.serviceType=type;c.stage='–ê–∫—Ç–∏–≤–Ω—ã–π';c.last=today();

  const subs=SUBSTAGES[type]||[];c.substage=subs[0]||'';

  if(c.substage&&STAGE_TASKS[c.substage]){

    STAGE_TASKS[c.substage].forEach(txt=>tasks.unshift({id:uid(),text:txt,client:cid,assignee:'',prio:'mid',stage:'todo',due:'',created:today(),cmts:[]}));

  }

  closeModal();renderAll();

  await apiPut('/clients/'+cid, c);

}

async function applyClientStage(cid){

  const c=clients.find(x=>x.id===cid);if(!c)return;

  c.stage=g('cs-stage').value;c.last=today();

  closeModal();renderKanban();renderClients();

  await apiPut('/clients/'+cid, c);

}

async function setSubstage(cid,sub){

  const c=clients.find(x=>x.id===cid);if(!c)return;

  c.substage=sub;c.last=today();

  if(STAGE_TASKS[sub]){

    STAGE_TASKS[sub].forEach(txt=>{if(!tasks.find(t=>t.client===cid&&t.text===txt))tasks.unshift({id:uid(),text:txt,client:cid,assignee:'',prio:'mid',stage:'todo',due:'',created:today(),cmts:[]});});

  }

  closeModal();openClientModal(cid);renderKanban();renderTasks();renderTaskStats();

  await apiPut('/clients/'+cid, c);

}

function openAddClientModal(stg='–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç'){

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">ID / Telegram ID</label><input class="mi" id="nc-id" placeholder="123456789"></div>

      <div class="mf"><label class="mfl">–ò–º—è *</label><input class="mi" id="nc-name"></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">Telegram</label><input class="mi" id="nc-tg" placeholder="@username"></div>

      <div class="mf"><label class="mfl">–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="mi" id="nc-phone"></div>

    </div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="createClient('${stg}')">–î–æ–±–∞–≤–∏—Ç—å</button>

    </div>`,'narrow');

}

async function createClient(stage){

  const name=g('nc-name').value.trim();if(!name)return;

  const c={id:g('nc-id').value||String(Date.now()),name,tg:g('nc-tg').value||'',phone:g('nc-phone').value||'',serviceType:'',stage,substage:'',last:today(),consulate:'',city:'',onboard:[false,false,false]};

  clients.unshift(c);

  closeModal();renderKanban();renderClients();renderDash();

  await apiPost('/clients', c);

}

// ============================================================

// STATUS EDIT HELPER (shared logic: date auto-update)

// ============================================================

function autoUpdatedDate(){return nowDMY();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// i18n  (RU / PT)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _lang = (() => { try{ return localStorage.getItem('crm_lang')||'ru'; }catch(e){return 'ru';} })();

const _STRINGS = {

  ru: {

    // sidebar sections

    sb_overview:'–û–±–∑–æ—Ä', sb_clients_sec:'–ö–ª–∏–µ–Ω—Ç—ã', sb_statuses_sec:'–°—Ç–∞—Ç—É—Å—ã',

    sb_schedule_sec:'–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', sb_work_sec:'–†–∞–±–æ—Ç–∞',

    // sidebar items

    ni_dashboard:'–î–∞—à–±–æ—Ä–¥', ni_clients:'–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã', ni_kanban:'–ö–∞–Ω–±–∞–Ω / Pipeline',

    ni_aima:'–ü—Ä–æ–≤–µ—Ä–∫–∏ AIMA', ni_visad:'–í–∏–∑–∞ D', ni_courts:'–°—É–¥—ã',

    ni_citizenship:'–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ', ni_rights:'–ü—Ä–∞–≤–∞',

    ni_schedule:'–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', ni_calendar:'–ö–∞–ª–µ–Ω–¥–∞—Ä—å',

    ni_tasks:'–ó–∞–¥–∞—á–∏', ni_integration:'API / –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',

    btn_sync:'–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å',

    // page titles

    pg_dashboard:'–î–∞—à–±–æ—Ä–¥', pg_clients:'–ö–ª–∏–µ–Ω—Ç—ã', pg_kanban:'Kanban Pipeline',

    pg_aima:'–ü—Ä–æ–≤–µ—Ä–∫–∏ AIMA', pg_visad:'–í–∏–∑–∞ D ‚Äî –°—Ç–∞—Ç—É—Å—ã', pg_courts:'–°—É–¥—ã',

    pg_citizenship:'–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ', pg_rights:'–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞',

    pg_schedule:'–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á', pg_calendar:'–ö–æ–º–∞–Ω–¥–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å',

    pg_tasks:'–ó–∞–¥–∞—á–∏', pg_integration:'API / –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',

    // search

    search_ph:'üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞, ID, telegram...',

    // dashboard KPI

    kpi_total:'–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤', kpi_total_s:'–í –±–∞–∑–µ CRM',

    kpi_review:'–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏', kpi_review_s:'–ê–Ω–∞–ª–∏–∑ AIMA',

    kpi_approved:'–ê–ø—Ä—É–≤', kpi_approved_s:'–û–¥–æ–±—Ä–µ–Ω–æ',

    kpi_meets:'–í—Å—Ç—Ä–µ—á —Å–µ–≥–æ–¥–Ω—è',

    // stats

    stats_lbl:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á –∑–∞:',

    stats_day:'–î–µ–Ω—å', stats_week:'–ù–µ–¥–µ–ª—è', stats_month:'–ú–µ—Å—è—Ü',

    ts_posted:'–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ', ts_progress:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ', ts_done:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ', ts_overdue:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ',

    // panels

    ph_my_tasks:'–ú–æ–∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏', ph_meets:'–ë–ª–∏–∂–∞–π—à–∏–µ –≤—Å—Ç—Ä–µ—á–∏',

    ph_meets_sub:'–≠—Ç–∞ –Ω–µ–¥–µ–ª—è', ph_aima:'–î–∞–≤–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ AIMA', ph_aima_sub:'–ü–æ –¥–∞—Ç–µ ‚Üë',

    ph_courts_old:'–°—É–¥—ã ‚Äî –ø–æ –¥–∞–≤–Ω–æ—Å—Ç–∏', ph_citizenship:'–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ', ph_rights_d:'–ü—Ä–∞–≤–∞',

    // sec titles

    sec_aima:'–ü—Ä–æ–≤–µ—Ä–∫–∏ AIMA', sec_visad:'–í–∏–∑–∞ D ‚Äî –°—Ç–∞—Ç—É—Å—ã', sec_courts:'–°—É–¥—ã',

    sec_citizenship:'–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ', sec_rights:'–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞',

    sec_schedule:'–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á', sec_calendar:'–ö–æ–º–∞–Ω–¥–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å',

    sec_tasks:'–ó–∞–¥–∞—á–∏', sec_integration:'API / –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',

    // table headers

    th_name:'–§–ò–û', th_service:'–¢–∏–ø —É—Å–ª—É–≥–∏', th_stage:'–≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏',

    th_substage:'–ü–æ–¥—ç—Ç–∞–ø', th_updated:'–ü–æ—Å–ª. –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ',

    th_num:'‚Ññ', th_nipc:'NIPC / –î–µ–ª–æ', th_dob:'–î–†', th_pass:'–ü–∞—Å–ø–æ—Ä—Ç',

    th_status:'–°—Ç–∞—Ç—É—Å', th_date_check:'–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏', th_section:'–°–µ–∫—Ü–∏—è',

    th_type:'–¢–∏–ø', th_date_upd:'–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', th_city:'–ì–æ—Ä–æ–¥', th_comment:'–ö–æ–º–º–µ–Ω—Ç.',

    th_article:'–°—Ç–∞—Ç—å—è', th_date_court:'–î–∞—Ç–∞', th_place:'–ú–µ—Å—Ç–æ', th_phase:'–≠—Ç–∞–ø',

    th_date_updated:'–û–±–Ω–æ–≤–ª—ë–Ω', th_date_submit:'–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏',

    th_track:'–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä', th_country:'–°—Ç—Ä–∞–Ω–∞ –ø—Ä–∞–≤',

    // buttons

    btn_add:'+ –î–æ–±–∞–≤–∏—Ç—å', btn_new_client:'+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç', btn_book_slot:'+ –ó–∞–Ω—è—Ç—å —Å–ª–æ—Ç',

    btn_add_task:'+ –ó–∞–¥–∞—á–∞',

    // chips

    chip_all:'–í—Å–µ',

    // scope

    scope_mine:'üë§ –ú–æ–∏', scope_all:'üë• –í—Å–µ',

    // user menu

    um_my_tasks:'‚òë –ú–æ–∏ –∑–∞–¥–∞—á–∏', um_profile:'‚öô –ü—Ä–æ—Ñ–∏–ª—å', um_logout:'‚¨° –í—ã–π—Ç–∏',

    // inline edit tooltips

    inline_status_tip:'–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞',

    inline_date_tip:'–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–º–µ–Ω—ã –¥–∞—Ç—ã',

    // delete

    del_title:'–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?', del_sub:'–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',

    del_cancel:'–û—Ç–º–µ–Ω–∞', del_confirm_btn:'–£–¥–∞–ª–∏—Ç—å',

    del_done:'–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ ‚úì',

    // no data

    no_data_cit:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤—É ‚Äî –Ω–∞–∂–º–∏—Ç–µ ‚Üª –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ + –î–æ–±–∞–≤–∏—Ç—å',

    no_data_rights:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∞–≤–∞–º ‚Äî –Ω–∞–∂–º–∏—Ç–µ ‚Üª –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ + –î–æ–±–∞–≤–∏—Ç—å',

    no_open_tasks:'–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á üéâ',

    // sched

    sched_choose:'–≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å', sched_free:'—Å–≤–æ–±–æ–¥–Ω–æ', sched_occupied:'–∑–∞–Ω—è—Ç',

  },

  pt: {

    sb_overview:'Vis√£o Geral', sb_clients_sec:'Clientes', sb_statuses_sec:'Estatutos',

    sb_schedule_sec:'Agenda', sb_work_sec:'Trabalho',

    ni_dashboard:'Dashboard', ni_clients:'Todos os Clientes', ni_kanban:'Kanban / Pipeline',

    ni_aima:'Verifica√ß√µes AIMA', ni_visad:'Visto D', ni_courts:'Tribunais',

    ni_citizenship:'Cidadania', ni_rights:'Carta de Condu√ß√£o',

    ni_schedule:'Agenda', ni_calendar:'Calend√°rio',

    ni_tasks:'Tarefas', ni_integration:'API / Integra√ß√µes',

    btn_sync:'Sincronizar',

    pg_dashboard:'Dashboard', pg_clients:'Clientes', pg_kanban:'Kanban Pipeline',

    pg_aima:'Verifica√ß√µes AIMA', pg_visad:'Visto D ‚Äî Estatutos', pg_courts:'Tribunais',

    pg_citizenship:'Cidadania', pg_rights:'Carta de Condu√ß√£o',

    pg_schedule:'Agenda de Reuni√µes', pg_calendar:'Calend√°rio da Equipa',

    pg_tasks:'Tarefas', pg_integration:'API / Integra√ß√µes',

    search_ph:'üîç Pesquisar cliente, ID, telegram...',

    kpi_total:'Total de Clientes', kpi_total_s:'Na base CRM',

    kpi_review:'Em An√°lise', kpi_review_s:'An√°lise AIMA',

    kpi_approved:'Aprovado', kpi_approved_s:'Aprovados',

    kpi_meets:'Reuni√µes Hoje',

    stats_lbl:'Estat√≠sticas de tarefas:',

    stats_day:'Dia', stats_week:'Semana', stats_month:'M√™s',

    ts_posted:'Criadas', ts_progress:'Em Curso', ts_done:'Conclu√≠das', ts_overdue:'Atrasadas',

    ph_my_tasks:'Minhas Tarefas Abertas', ph_meets:'Pr√≥ximas Reuni√µes',

    ph_meets_sub:'Esta Semana', ph_aima:'Verifica√ß√µes AIMA Antigas', ph_aima_sub:'Por data ‚Üë',

    ph_courts_old:'Tribunais ‚Äî por antiguidade', ph_citizenship:'Cidadania', ph_rights_d:'Cartas de Condu√ß√£o',

    sec_aima:'Verifica√ß√µes AIMA', sec_visad:'Visto D ‚Äî Estatutos', sec_courts:'Tribunais',

    sec_citizenship:'Cidadania', sec_rights:'Carta de Condu√ß√£o',

    sec_schedule:'Agenda de Reuni√µes', sec_calendar:'Calend√°rio da Equipa',

    sec_tasks:'Tarefas', sec_integration:'API / Integra√ß√µes',

    th_name:'Nome Completo', th_service:'Tipo de Servi√ßo', th_stage:'Fase',

    th_substage:'Sub-fase', th_updated:'√öltima Atualiza√ß√£o',

    th_num:'N¬∫', th_nipc:'NIPC / Processo', th_dob:'Nasc.', th_pass:'Passaporte',

    th_status:'Estatuto', th_date_check:'Data de Verifica√ß√£o', th_section:'Sec√ß√£o',

    th_type:'Tipo', th_date_upd:'Data de Atualiza√ß√£o', th_city:'Cidade', th_comment:'Coment.',

    th_article:'Artigo', th_date_court:'Data', th_place:'Local', th_phase:'Fase',

    th_date_updated:'Atualizado', th_date_submit:'Data de Submiss√£o',

    th_track:'N¬∫ Rastreio', th_country:'Pa√≠s da Carta',

    btn_add:'+ Adicionar', btn_new_client:'+ Novo Cliente', btn_book_slot:'+ Reservar Slot',

    btn_add_task:'+ Tarefa',

    chip_all:'Todos',

    scope_mine:'üë§ Minhas', scope_all:'üë• Todas',

    um_my_tasks:'‚òë Minhas Tarefas', um_profile:'‚öô Perfil', um_logout:'‚¨° Sair',

    inline_status_tip:'Clique para alterar estatuto',

    inline_date_tip:'Clique para alterar data',

    del_title:'Eliminar registo?', del_sub:'Esta a√ß√£o n√£o pode ser desfeita.',

    del_cancel:'Cancelar', del_confirm_btn:'Eliminar',

    del_done:'Registo eliminado ‚úì',

    no_data_cit:'Sem dados de cidadania ‚Äî clique ‚Üª Sincronizar ou + Adicionar',

    no_data_rights:'Sem dados de carta ‚Äî clique ‚Üª Sincronizar ou + Adicionar',

    no_open_tasks:'Sem tarefas abertas üéâ',

    sched_choose:'escolha um dia', sched_free:'livre', sched_occupied:'ocupado',

  }

};

/** Translate key */

function _t(k){ return (_STRINGS[_lang]||_STRINGS.ru)[k] || _STRINGS.ru[k] || k; }

function setLang(lang, btn){

  _lang = lang;

  try{ localStorage.setItem('crm_lang', lang); }catch(e){}

  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));

  if(btn) btn.classList.add('active');

  _applyI18n();

  renderAll(); renderCal(); renderSchedMini();

}

const _NI_MAP = {

  dashboard:'ni_dashboard', clients:'ni_clients', kanban:'ni_kanban',

  aima:'ni_aima', visad:'ni_visad', courts:'ni_courts',

  citizenship:'ni_citizenship', rights:'ni_rights',

  schedule:'ni_schedule', calendar:'ni_calendar',

  tasks:'ni_tasks', integration:'ni_integration'

};

const _SEC_MAP = {

  '–û–±–∑–æ—Ä':'sb_overview','Vis√£o Geral':'sb_overview',

  '–ö–ª–∏–µ–Ω—Ç—ã':'sb_clients_sec','Clientes':'sb_clients_sec',

  '–°—Ç–∞—Ç—É—Å—ã':'sb_statuses_sec','Estatutos':'sb_statuses_sec',

  '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ':'sb_schedule_sec','Agenda':'sb_schedule_sec',

  '–†–∞–±–æ—Ç–∞':'sb_work_sec','Trabalho':'sb_work_sec',

};

const _SECTITLE_MAP = {

  '–ü—Ä–æ–≤–µ—Ä–∫–∏ AIMA':'sec_aima','Verifica√ß√µes AIMA':'sec_aima',

  '–í–∏–∑–∞ D ‚Äî –°—Ç–∞—Ç—É—Å—ã':'sec_visad','Visto D ‚Äî Estatutos':'sec_visad',

  '–°—É–¥—ã':'sec_courts','Tribunais':'sec_courts',

  '–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ':'sec_citizenship','Cidadania':'sec_citizenship',

  '–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞':'sec_rights','Carta de Condu√ß√£o':'sec_rights',

  '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á':'sec_schedule','Agenda de Reuni√µes':'sec_schedule',

  '–ö–æ–º–∞–Ω–¥–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å':'sec_calendar','Calend√°rio da Equipa':'sec_calendar',

  '–ó–∞–¥–∞—á–∏':'sec_tasks','Tarefas':'sec_tasks',

  'API / –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏':'sec_integration','API / Integra√ß√µes':'sec_integration',

  'Kanban Pipeline':'pg_kanban',

};

const _TH_MAP = {

  '–§–ò–û':'th_name','Nome Completo':'th_name',

  '–¢–∏–ø —É—Å–ª—É–≥–∏':'th_service','Tipo de Servi√ßo':'th_service',

  '–≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏':'th_stage','Fase':'th_stage',

  '–ü–æ–¥—ç—Ç–∞–ø':'th_substage','Sub-fase':'th_substage',

  '–ü–æ—Å–ª. –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ':'th_updated','√öltima Atualiza√ß√£o':'th_updated',

  '‚Ññ':'th_num','N¬∫':'th_num',

  'NIPC / –î–µ–ª–æ':'th_nipc','NIPC / Processo':'th_nipc',

  '–î–†':'th_dob','Nasc.':'th_dob',

  '–ü–∞—Å–ø–æ—Ä—Ç':'th_pass','Passaporte':'th_pass',

  '–°—Ç–∞—Ç—É—Å':'th_status','Estatuto':'th_status',

  '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏':'th_date_check','Data de Verifica√ß√£o':'th_date_check',

  '–°–µ–∫—Ü–∏—è':'th_section','Sec√ß√£o':'th_section',

  '–¢–∏–ø':'th_type',

  '–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è':'th_date_upd','Data de Atualiza√ß√£o':'th_date_upd',

  '–ì–æ—Ä–æ–¥':'th_city','Cidade':'th_city',

  '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π':'th_comment','–ö–æ–º–º–µ–Ω—Ç.':'th_comment','Coment.':'th_comment',

  '–°—Ç–∞—Ç—å—è':'th_article','Artigo':'th_article',

  '–î–∞—Ç–∞':'th_date_court',

  '–ú–µ—Å—Ç–æ':'th_place','Local':'th_place',

  '–≠—Ç–∞–ø':'th_phase',

  '–û–±–Ω–æ–≤–ª—ë–Ω':'th_date_updated','Atualizado':'th_date_updated',

  '–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏':'th_date_submit','Data de Submiss√£o':'th_date_submit',

  '–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä':'th_track','N¬∫ Rastreio':'th_track',

  '–°—Ç—Ä–∞–Ω–∞ –ø—Ä–∞–≤':'th_country','Pa√≠s da Carta':'th_country',

};

function _applyI18n(){

  document.documentElement.lang = _lang==='pt'?'pt':'ru';

  // Sidebar sections

  document.querySelectorAll('.sb-sec').forEach(s=>{

    const k=_SEC_MAP[s.textContent.trim()]; if(k) s.textContent=_t(k);

  });

  // Nav items

  document.querySelectorAll('.ni[onclick]').forEach(ni=>{

    const m=ni.getAttribute('onclick').match(/showView\('(\w+)'/);

    if(!m) return;

    const k=_NI_MAP[m[1]]; if(!k) return;

    const ic=ni.querySelector('.ni-ic');

    const bdg=ni.querySelector('.ni-bdg');

    ni.textContent=_t(k);

    if(ic) ni.prepend(ic);

    if(bdg) ni.appendChild(bdg);

  });

  // Sync button

  const sb=document.querySelector('.sync-btn');

  if(sb){ const sp=g('sync-spin'); sb.textContent=_t('btn_sync'); if(sp)sb.prepend(sp); }

  // Search

  const sr=g('tb-search'); if(sr) sr.placeholder=_t('search_ph');

  // Page title (current view)

  const pgt=g('pg-title');

  if(pgt){ const v=document.querySelector('.view.active'); if(v){ const id=v.id.replace('view-',''); pgt.textContent=_t('pg_'+id)||pgt.textContent; } }

  // KPI labels

  [['kpi-total-l','kpi_total'],['kpi-total-s','kpi_total_s'],

   ['kpi-review-l','kpi_review'],['kpi-review-s','kpi_review_s'],

   ['kpi-approved-l','kpi_approved'],['kpi-approved-s','kpi_approved_s'],

   ['kpi-meets-l','kpi_meets'],

   ['ts-label-stat','stats_lbl'],

   ['ts-fc-day','stats_day'],['ts-fc-week','stats_week'],['ts-fc-month','stats_month'],

  ].forEach(([id,k])=>{ const el=g(id); if(el) el.textContent=_t(k); });

  // ts-l cards

  const tsKeys=['ts_posted','ts_progress','ts_done','ts_overdue'];

  document.querySelectorAll('.ts-l').forEach((c,i)=>{ if(tsKeys[i]) c.textContent=_t(tsKeys[i]); });

  // Panel headers

  const phId=g('dash-my-tasks-title'); if(phId) phId.textContent=_t('ph_my_tasks');

  const _phTxt={

    '–ë–ª–∏–∂–∞–π—à–∏–µ –≤—Å—Ç—Ä–µ—á–∏':'ph_meets','Pr√≥ximas Reuni√µes':'ph_meets',

    '–î–∞–≤–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ AIMA':'ph_aima','Verifica√ß√µes AIMA Antigas':'ph_aima',

    '–°—É–¥—ã ‚Äî –ø–æ –¥–∞–≤–Ω–æ—Å—Ç–∏':'ph_courts_old','Tribunais ‚Äî por antiguidade':'ph_courts_old',

    '–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ':'ph_citizenship','Cidadania':'ph_citizenship',

    '–ü—Ä–∞–≤–∞':'ph_rights_d','Cartas de Condu√ß√£o':'ph_rights_d',

  };

  document.querySelectorAll('.ph-title').forEach(ph=>{

    const k=_phTxt[ph.textContent.trim()]; if(k) ph.textContent=_t(k);

  });

  const _phCnt={'–≠—Ç–∞ –Ω–µ–¥–µ–ª—è':'ph_meets_sub','Esta Semana':'ph_meets_sub','–ü–æ –¥–∞—Ç–µ ‚Üë':'ph_aima_sub','Por data ‚Üë':'ph_aima_sub'};

  document.querySelectorAll('.ph-cnt').forEach(c=>{

    const k=_phCnt[c.textContent.trim()]; if(k) c.textContent=_t(k);

  });

  // Section titles

  document.querySelectorAll('.sec-t').forEach(st=>{

    const k=_SECTITLE_MAP[st.textContent.trim()]; if(k) st.textContent=_t(k);

  });

  // Table headers

  document.querySelectorAll('.dt thead th').forEach(th=>{

    const k=_TH_MAP[th.textContent.trim()]; if(k) th.textContent=_t(k);

  });

  // Chip "–í—Å–µ"

  document.querySelectorAll('.chip').forEach(c=>{

    if(c.textContent.trim()==='–í—Å–µ'||c.textContent.trim()==='Todos') c.textContent=_t('chip_all');

  });

  // Scope btns

  const sm=g('scope-mine'),sa=g('scope-all');

  if(sm) sm.textContent=_t('scope_mine');

  if(sa) sa.textContent=_t('scope_all');

  // User menu

  const um=document.querySelectorAll('.usr-menu-item');

  if(um[0]) um[0].textContent=_t('um_my_tasks');

  if(um[1]) um[1].textContent=_t('um_profile');

  if(um[2]) um[2].textContent=_t('um_logout');

  // Sec-a buttons

  const _btnTxt={

    '+ –î–æ–±–∞–≤–∏—Ç—å':'btn_add','+ Adicionar':'btn_add',

    '+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç':'btn_new_client','+ Novo Cliente':'btn_new_client',

    '+ –ó–∞–Ω—è—Ç—å —Å–ª–æ—Ç':'btn_book_slot','+ Reservar Slot':'btn_book_slot',

    '+ –ó–∞–¥–∞—á–∞':'btn_add_task','+ Tarefa':'btn_add_task',

    '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å':'btn_sync','Sincronizar':'btn_sync',

  };

  document.querySelectorAll('.btn').forEach(b=>{

    const k=_btnTxt[b.textContent.trim()]; if(k) b.textContent=_t(k);

  });

  // Sched choose label

  const scd=g('sched-sel-d');

  if(scd&&(scd.textContent==='–≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å'||scd.textContent==='escolha um dia'))

    scd.textContent=_t('sched_choose');

}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// DELETE ‚Äî –∫–Ω–æ–ø–∫–∞ üóë –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö —Å—Ç–∞—Ç—É—Å–æ–≤

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _delPop = null;

function _closeDelPop(){

  if(_delPop){ _delPop.remove(); _delPop=null; }

}

/** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ onclick –∫–Ω–æ–ø–∫–∏ üóë */

function handleDelBtn(btn, e){

  e.stopPropagation();

  closeAllDropdowns();

  _closeDelPop();

  const mod = btn.dataset.mod;

  const idx = parseInt(btn.dataset.idx);

  const lbl = decodeURIComponent(btn.dataset.lbl||'');

  const rect = btn.getBoundingClientRect();

  const pop = document.createElement('div');

  pop.className = 'del-pop';

  pop.innerHTML =

    '<h4>'+_t('del_title')+'</h4>'

   +'<p>'+lbl+'<br><span style="color:var(--red);font-size:10px">'+_t('del_sub')+'</span></p>'

   +'<div class="del-pop-btns">'

     +'<button class="dpc" onclick="_closeDelPop()">'+_t('del_cancel')+'</button>'

     +'<button class="dpd" onclick="_execDelete(\''+mod+'\','+idx+')">'+_t('del_confirm_btn')+'</button>'

   +'</div>';

  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å

  pop.style.cssText = 'top:'+(rect.bottom+4)+'px;left:'+Math.max(rect.right-270,8)+'px';

  document.body.appendChild(pop);

  _delPop = pop;

  // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ —Å–Ω–∞—Ä—É–∂–∏

  setTimeout(()=>{

    const out=(ev)=>{ if(!pop.contains(ev.target)){_closeDelPop();document.removeEventListener('click',out);} };

    document.addEventListener('click',out);

  },50);

  // –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –≤—ã—à–µ–ª –∑–∞ —ç–∫—Ä–∞–Ω

  requestAnimationFrame(()=>{

    if(!pop) return;

    const r=pop.getBoundingClientRect();

    if(r.bottom>window.innerHeight-8) pop.style.top=(rect.top-r.height-4)+'px';

    if(r.right>window.innerWidth-8)   pop.style.left=(window.innerWidth-r.width-8)+'px';

  });

}

async function _execDelete(mod, idx){

  _closeDelPop();

  let key, apiPath;

  if(mod==='aima'){

    key=statuses[idx]?.num; apiPath='/statuses';

    statuses.splice(idx,1); renderAIMA(); renderDash();

  } else if(mod==='visad'){

    key=visaD[idx]?.num; apiPath='/visad';

    visaD.splice(idx,1); renderVisaD();

  } else if(mod==='courts'){

    key=courts[idx]?.num; apiPath='/courts';

    courts.splice(idx,1); renderCourts(); renderDash();

  } else if(mod==='citizenship'){

    key=citizenship[idx]?.num; apiPath='/citizenship';

    citizenship.splice(idx,1); renderCitizenship(); renderDash();

  } else if(mod==='rights'){

    key=rights[idx]?.num; apiPath='/rights';

    rights.splice(idx,1); renderRights();

  }

  toast(_t('del_done'));

  if(key) await apiFetch(apiPath+'/'+key,{method:'DELETE'}).catch(()=>{});

}

// ============================================================

// INLINE STATUS & DATE EDITOR

// ============================================================

let _openDropdown = null; // —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π dropdown

function closeAllDropdowns(){

  if(_openDropdown){_openDropdown.remove();_openDropdown=null;}

  const dp=document.querySelector('.date-popup');

  if(dp)dp.remove();

}

document.addEventListener('click', e=>{

  if(!e.target.closest('.status-dropdown')&&!e.target.closest('.inline-status'))closeAllDropdowns();

  if(!e.target.closest('.date-popup')&&!e.target.closest('.inline-date'))closeAllDropdowns();

});

// ---- INLINE STATUS DROPDOWN ----

// module: 'aima'|'visad'|'courts'|'citizenship'|'rights'

// idx: –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ

// currentStatus: —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

// statuses_arr: –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

// apiPath: –ø—É—Ç—å PUT /api/.../:key

// keyField: –ø–æ–ª–µ-–∫–ª—é—á –¥–ª—è PUT (num, id, etc.)

function openStatusDropdown(e, module, idx, currentStatus, statusArr, apiPath, keyField){

  e.stopPropagation();

  closeAllDropdowns();

  

  const rect = e.currentTarget.getBoundingClientRect();

  const dd = document.createElement('div');

  dd.className = 'status-dropdown';

  dd.style.top = (rect.bottom + 4) + 'px';

  dd.style.left = rect.left + 'px';

  // –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ –Ω–µ –≤—ã—à–ª–∏ –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π

  dd.innerHTML = statusArr.map(s=>`

    <div class="status-dropdown-item ${s===currentStatus?'current':''}" onclick="applyInlineStatus('${module}',${idx},'${s.replace(/'/g,"\\'")}','${apiPath}','${keyField}',this)">

      ${s===currentStatus?'‚úì ':''}<span>${s}</span>

    </div>`).join('');

  document.body.appendChild(dd);

  _openDropdown = dd;

  

  // –ü–æ–¥–≤–∏–Ω—É—Ç—å –µ—Å–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π

  requestAnimationFrame(()=>{

    const ddRect = dd.getBoundingClientRect();

    if(ddRect.right > window.innerWidth - 8){

      dd.style.left = (window.innerWidth - ddRect.width - 8) + 'px';

    }

    if(ddRect.bottom > window.innerHeight - 8){

      dd.style.top = (rect.top - ddRect.height - 4) + 'px';

    }

  });

}

async function applyInlineStatus(module, idx, newStatus, apiPath, keyField, el){

  closeAllDropdowns();

  const today = nowDMY();

  

  // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å

  let obj, key;

  if(module==='aima'){

    statuses[idx].status = newStatus;

    statuses[idx].date = today;

    key = statuses[idx][keyField];

    renderAIMA(); renderDash();

  } else if(module==='visad'){

    visaD[idx].status = newStatus;

    visaD[idx].updated = today;

    key = visaD[idx][keyField];

    renderVisaD();

  } else if(module==='courts'){

    courts[idx].status = newStatus;

    courts[idx].updated = today;

    key = courts[idx][keyField];

    renderCourts(); renderDash();

  } else if(module==='citizenship'){

    citizenship[idx].status = newStatus;

    citizenship[idx].updated = today;

    key = citizenship[idx][keyField];

    renderCitizenship(); renderDash();

  } else if(module==='rights'){

    rights[idx].status = newStatus;

    rights[idx].updated = today;

    key = rights[idx][keyField];

    renderRights();

  }

  

  toast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω: ' + newStatus + ' ‚úì');

  

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å Google Sheets —á–µ—Ä–µ–∑ API

  const data = module==='aima'

    ? {status:newStatus, date:today}

    : {status:newStatus, updated:today};

  await apiPut(apiPath+'/'+key, data);

}

// ---- INLINE DATE EDITOR ----

function openDatePopup(e, module, idx, currentDate, apiPath, keyField){

  e.stopPropagation();

  closeAllDropdowns();

  

  const rect = e.currentTarget.getBoundingClientRect();

  const dp = document.createElement('div');

  dp.className = 'date-popup';

  dp.style.top = (rect.bottom + 4) + 'px';

  dp.style.left = rect.left + 'px';

  dp.innerHTML = `

    <div class="date-popup-title">–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>

    <input id="dp-input" value="${currentDate||''}" placeholder="DD.MM.YYYY" maxlength="10">

    <div class="date-popup-btns">

      <button class="dp-today" onclick="setDateToday('${module}',${idx},'${apiPath}','${keyField}')">–°–µ–≥–æ–¥–Ω—è</button>

      <button class="dp-cancel" onclick="closeAllDropdowns()">‚úï</button>

      <button class="dp-save" onclick="applyInlineDate('${module}',${idx},'${apiPath}','${keyField}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

    </div>`;

  document.body.appendChild(dp);

  

  // –ú–∞—Å–∫–∞ DD.MM.YYYY

  const inp = dp.querySelector('#dp-input');

  inp.focus(); inp.select();

  inp.addEventListener('input', ()=>{

    let v=inp.value.replace(/[^\d]/g,'');

    if(v.length>2)v=v.slice(0,2)+'.'+v.slice(2);

    if(v.length>5)v=v.slice(0,5)+'.'+v.slice(5);

    inp.value=v.slice(0,10);

  });

  inp.addEventListener('keydown', e=>{if(e.key==='Enter')applyInlineDate(module,idx,apiPath,keyField);if(e.key==='Escape')closeAllDropdowns();});

  

  requestAnimationFrame(()=>{

    const r=dp.getBoundingClientRect();

    if(r.right>window.innerWidth-8)dp.style.left=(window.innerWidth-r.width-8)+'px';

    if(r.bottom>window.innerHeight-8)dp.style.top=(rect.top-r.height-4)+'px';

  });

}

function setDateToday(module,idx,apiPath,keyField){

  const inp=document.querySelector('#dp-input');

  if(inp)inp.value=nowDMY();

  applyInlineDate(module,idx,apiPath,keyField);

}

async function applyInlineDate(module,idx,apiPath,keyField){

  const inp=document.querySelector('#dp-input');

  const newDate=inp?inp.value.trim():nowDMY();

  closeAllDropdowns();

  

  let key;

  if(module==='aima'){

    statuses[idx].date=newDate; key=statuses[idx][keyField]; renderAIMA();

  } else if(module==='visad'){

    visaD[idx].updated=newDate; key=visaD[idx][keyField]; renderVisaD();

  } else if(module==='courts'){

    courts[idx].updated=newDate; key=courts[idx][keyField]; renderCourts();

  } else if(module==='citizenship'){

    citizenship[idx].updated=newDate; key=citizenship[idx][keyField]; renderCitizenship();

  } else if(module==='rights'){

    rights[idx].updated=newDate; key=rights[idx][keyField]; renderRights();

  }

  

  toast('–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: '+newDate+' ‚úì');

  

  const field = module==='aima' ? 'date' : 'updated';

  await apiPut(apiPath+'/'+key, {[field]:newDate});

}

// ============================================================

// AIMA STATUSES

// ============================================================

function renderAIMA(data){

  const arr=data||statuses;

  g('aima-tbody').innerHTML=arr.map((s)=>{

    const ri=statuses.findIndex(x=>x.num===s.num&&x.name===s.name);

    return '<tr>'

      +'<td class="mono" style="color:var(--acc)">'+s.num+'</td>'

      +'<td style="font-weight:600">'+s.name+'</td>'

      +'<td class="mono" style="font-size:11px">'+s.nipc+'</td>'

      +'<td class="mono" style="font-size:11px">'+(s.dob||'‚Äî')+'</td>'

      +'<td class="mono" style="font-size:11px">'+(s.pass||'‚Äî')+'</td>'

      +'<td class="inline-edit-cell"><span class="inline-status" onclick="openStatusDropdown(event,\'aima\','+ri+',\''+s.status+'\',AIMA_STATUSES,\'/statuses\',\'num\')" title="'+_t('inline_status_tip')+'">'+bdg(s.status)+'</span></td>'

      +'<td class="inline-edit-cell"><span class="inline-date" onclick="openDatePopup(event,\'aima\','+ri+',\''+(s.date||'')+'\',\'/statuses\',\'num\')" title="'+_t('inline_date_tip')+'">'+(s.date||'‚Äî')+'</span></td>'

      +'<td><span class="bdg '+(s.sec==='–ú–ê–ù–ò–§–ï–°–¢'?'pur':'gry')+'">'+s.sec+'</span></td>'

      +'<td style="white-space:nowrap">'

        +'<button class="edit-btn" onclick="editAIMA('+ri+',event)">‚úè</button>'

        +'<button class="del-btn" data-mod="aima" data-idx="'+ri+'" data-lbl="'+encodeURIComponent(s.num+' '+s.name)+'" onclick="handleDelBtn(this,event)">üóë</button>'

      +'</td>'

      +'</tr>';

  }).join('');

}

function filterAIMA(f,el){

  document.querySelectorAll('#aima-filter-chips .chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');

  renderAIMA(f==='all'?statuses:statuses.filter(s=>s.status===f));

}

function editAIMA(idx,e){

  e&&e.stopPropagation();

  const s=statuses[idx];

  openModal(`

    <div class="mhdr">

      <div>

        <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å AIMA</div>

        <div style="font-size:11px;color:var(--t3);margin-top:2px">${s.name} ¬∑ ${s.nipc}</div>

      </div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf">

        <label class="mfl">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</label>

        <select class="ms" id="ea-status">

          ${AIMA_STATUSES.map(v=>`<option ${s.status===v?'selected':''}>${v}</option>`).join('')}

        </select>

      </div>

      <div class="mf">

        <label class="mfl">–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ <span style="color:var(--gre);font-size:8px">‚Üê –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span></label>

        <input class="mi" id="ea-date" value="${s.date}" placeholder="DD/MM/YYYY">

      </div>

    </div>

    <div style="background:var(--acc-d);border-radius:6px;padding:8px 10px;font-size:10px;color:var(--acc);margin-bottom:10px">

      ‚Ñπ –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (${nowDMY()}), –µ—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é.

    </div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="saveAIMA(${idx})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>

    </div>`,'narrow');

}

async function saveAIMA(idx){

  const newStatus=g('ea-status').value;

  const newDate=g('ea-date').value||nowDMY();

  statuses[idx].status=newStatus;

  statuses[idx].date=newDate;

  closeModal();renderAIMA();renderDash();toast('–°—Ç–∞—Ç—É—Å AIMA –æ–±–Ω–æ–≤–ª—ë–Ω ‚úì');

  await apiPut('/statuses/'+statuses[idx].num, {status:newStatus, date:newDate});

}

// ============================================================

// VISA D

// ============================================================

function renderVisaD(){

  g('visad-tbody').innerHTML=visaD.map((v,i)=>{

    return '<tr>'

      +'<td class="mono" style="color:var(--acc)">'+v.num+'</td>'

      +'<td style="font-weight:600">'+v.name+'</td>'

      +'<td><span class="bdg blu">'+v.type+'</span></td>'

      +'<td class="mono" style="font-size:11px">'+(v.dob||'‚Äî')+'</td>'

      +'<td class="mono" style="font-size:11px">'+(v.pass||'‚Äî')+'</td>'

      +'<td class="inline-edit-cell"><span class="inline-status" onclick="openStatusDropdown(event,\'visad\','+i+',\''+v.status+'\',VD_STATUSES,\'/visad\',\'num\')" title="'+_t('inline_status_tip')+'">'+bdg(v.status)+'</span></td>'

      +'<td class="inline-edit-cell"><span class="inline-date" onclick="openDatePopup(event,\'visad\','+i+',\''+(v.updated||v.date||'')+'\',\'/visad\',\'num\')" title="'+_t('inline_date_tip')+'">'+(v.updated||v.date||'‚Äî')+'</span></td>'

      +'<td style="font-size:11px">'+(v.city||'‚Äî')+'</td>'

      +'<td style="font-size:11px;color:var(--t2);max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(v.comment||'‚Äî')+'</td>'

      +'<td style="white-space:nowrap">'

        +'<button class="edit-btn" onclick="editVisaD('+i+',event)">‚úè</button>'

        +'<button class="del-btn" data-mod="visad" data-idx="'+i+'" data-lbl="'+encodeURIComponent(v.num+' '+v.name)+'" onclick="handleDelBtn(this,event)">üóë</button>'

      +'</td>'

      +'</tr>';

  }).join('');

}

function editVisaD(idx,e){

  e&&e.stopPropagation();

  const v=idx<0?{num:'',name:'',type:'DN',dob:'',pass:'',status:'–ê–Ω–∞–ª–∏–∑',date:'',updated:'',city:'',comment:''}:visaD[idx];

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">${idx<0?'–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å':'–ò–∑–º–µ–Ω–∏—Ç—å'} ‚Äî –í–∏–∑–∞ D</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">‚Ññ –∫–ª–∏–µ–Ω—Ç–∞</label><input class="mi" id="vd-num" value="${v.num}"></div>

      <div class="mf"><label class="mfl">–§–ò–û</label><input class="mi" id="vd-name" value="${v.name}"></div>

      <div class="mf"><label class="mfl">–¢–∏–ø –≤–∏–∑—ã</label><input class="mi" id="vd-type" value="${v.type}" placeholder="DN, D7, D3..."></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–î–†</label><input class="mi" id="vd-dob" value="${v.dob}"></div>

      <div class="mf"><label class="mfl">–ü–∞—Å–ø–æ—Ä—Ç</label><input class="mi" id="vd-pass" value="${v.pass}"></div>

      <div class="mf"><label class="mfl">–ì–æ—Ä–æ–¥</label><input class="mi" id="vd-city" value="${v.city}"></div>

    </div>

    <div class="mrow">

      <div class="mf">

        <label class="mfl">–°—Ç–∞—Ç—É—Å <span style="color:var(--gre);font-size:8px">‚Üê –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span></label>

        <select class="ms" id="vd-status" onchange="toggleVdCustom(this.value)">

          ${VD_STATUSES.map(s=>`<option ${v.status===s?'selected':''}>${s}</option>`).join('')}

          <option value="__custom__">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é...</option>

        </select>

      </div>

      <div class="mf"><label class="mfl">–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏ / –ø–æ–¥–∞—á–∏</label><input class="mi" id="vd-date" value="${v.date}"></div>

    </div>

    <div id="vd-custom" style="display:none;margin-bottom:10px">

      <label class="mfl">–°—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é</label>

      <input class="mi" id="vd-custom-val" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å">

    </div>

    <div class="msec"><label class="mfl">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea class="mta" id="vd-comment">${v.comment}</textarea></div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="saveVisaD(${idx})">${idx<0?'–î–æ–±–∞–≤–∏—Ç—å':'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</button>

    </div>`);

}

function toggleVdCustom(v){g('vd-custom').style.display=v==='__custom__'?'block':'none';}

async function saveVisaD(idx){

  let st=g('vd-status').value;

  if(st==='__custom__')st=g('vd-custom-val').value||'‚Äî';

  const obj={num:g('vd-num').value,name:g('vd-name').value,type:g('vd-type').value,dob:g('vd-dob').value,pass:g('vd-pass').value,status:st,date:g('vd-date').value,updated:nowDMY(),city:g('vd-city').value,comment:g('vd-comment').value};

  if(idx<0)visaD.push(obj);else visaD[idx]=obj;

  closeModal();renderVisaD();toast(idx<0?'–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úì':'–í–∏–∑–∞ D –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úì');

  await (idx<0?apiPost('/visad',obj):apiPut('/visad/'+obj.num,obj));

}

// ============================================================

// COURTS

// ============================================================

function renderCourts(data){

  g('courts-tbody').innerHTML=(data||courts).map((c,i)=>{

    const ri=courts.findIndex(x=>x.num===c.num&&x.name===c.name);

    return '<tr>'

      +'<td class="mono" style="color:var(--pur)">'+c.num+'</td>'

      +'<td style="font-weight:600">'+c.name+'</td>'

      +'<td><span class="bdg pur">'+c.article+'</span></td>'

      +'<td class="mono" style="font-size:11px">'+c.date+'</td>'

      +'<td style="font-size:11px">'+c.place+'</td>'

      +'<td style="font-size:11px;color:var(--pur)">'+c.stage+'</td>'

      +'<td class="inline-edit-cell"><span class="inline-status" onclick="openStatusDropdown(event,\'courts\','+ri+',\''+c.status+'\',COURT_STATUSES,\'/courts\',\'num\')" title="'+_t('inline_status_tip')+'">'+bdg(c.status)+'</span></td>'

      +'<td class="inline-edit-cell"><span class="inline-date" onclick="openDatePopup(event,\'courts\','+ri+',\''+(c.updated||'')+'\',\'/courts\',\'num\')" title="'+_t('inline_date_tip')+'">'+(c.updated||'‚Äî')+'</span></td>'

      +'<td style="font-size:11px;color:var(--t2);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(c.comment||'‚Äî')+'</td>'

      +'<td style="white-space:nowrap">'

        +'<button class="edit-btn" onclick="editCourt('+ri+',event)">‚úè</button>'

        +'<button class="del-btn" data-mod="courts" data-idx="'+ri+'" data-lbl="'+encodeURIComponent(c.num+' '+c.name)+'" onclick="handleDelBtn(this,event)">üóë</button>'

      +'</td>'

      +'</tr>';

  }).join('');

}

function filterCourts(f,el){

  document.querySelectorAll('#courts-chips .chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');

  renderCourts(f==='all'?courts:courts.filter(c=>c.article===f));

}

function editCourt(idx,e){

  e&&e.stopPropagation();

  const c=idx<0?{num:'',name:'',article:'90.2',date:'',place:'',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:''}:courts[idx];

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">${idx<0?'–ù–æ–≤–æ–µ –¥–µ–ª–æ':'–ò–∑–º–µ–Ω–∏—Ç—å –¥–µ–ª–æ'} ‚Äî –°—É–¥</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">‚Ññ –∫–ª–∏–µ–Ω—Ç–∞</label><input class="mi" id="ct-num" value="${c.num}"></div>

      <div class="mf"><label class="mfl">–§–ò–û</label><input class="mi" id="ct-name" value="${c.name}"></div>

      <div class="mf"><label class="mfl">–°—Ç–∞—Ç—å—è</label><input class="mi" id="ct-art" value="${c.article}" placeholder="90.2, 98.2..."></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–î–∞—Ç–∞ —Å—É–¥–∞</label><input class="mi" id="ct-date" value="${c.date}" placeholder="DD/MM/YYYY"></div>

      <div class="mf"><label class="mfl">–ú–µ—Å—Ç–æ</label><input class="mi" id="ct-place" value="${c.place}"></div>

    </div>

    <div class="mrow">

      <div class="mf">

        <label class="mfl">–≠—Ç–∞–ø</label>

        <select class="ms" id="ct-stage">${COURT_STAGES.map(s=>`<option ${c.stage===s?'selected':''}>${s}</option>`).join('')}</select>

      </div>

      <div class="mf">

        <label class="mfl">–°—Ç–∞—Ç—É—Å <span style="color:var(--gre);font-size:8px">‚Üê –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è</span></label>

        <input class="mi" id="ct-status" value="${c.status}" placeholder="–í –ø—Ä–æ—Ü–µ—Å—Å–µ, –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è...">

      </div>

    </div>

    <div class="msec"><label class="mfl">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea class="mta" id="ct-comment">${c.comment}</textarea></div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="saveCourt(${idx})">${idx<0?'–î–æ–±–∞–≤–∏—Ç—å':'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</button>

    </div>`);

}

async function saveCourt(idx){

  const obj={num:g('ct-num').value,name:g('ct-name').value,article:g('ct-art').value,date:g('ct-date').value,place:g('ct-place').value,stage:g('ct-stage').value,status:g('ct-status').value,updated:nowDMY(),comment:g('ct-comment').value};

  if(idx<0)courts.push(obj);else courts[idx]=obj;

  closeModal();renderCourts();renderDash();toast(idx<0?'–î–µ–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ‚úì':'–°—É–¥ –æ–±–Ω–æ–≤–ª—ë–Ω ‚úì');

  await (idx<0?apiPost('/courts',obj):apiPut('/courts/'+obj.num,obj));

}

// ============================================================

// CITIZENSHIP

// ============================================================

function renderCitizenship(){

  g('cit-tbody').innerHTML=citizenship.length?citizenship.map((c,i)=>{

    return '<tr>'

      +'<td class="mono" style="color:var(--ora)">'+c.num+'</td>'

      +'<td style="font-weight:600">'+c.name+'</td>'

      +'<td><span class="bdg ora">'+(c.type||'‚Äî')+'</span></td>'

      +'<td class="mono" style="font-size:11px">'+(c.date||'‚Äî')+'</td>'

      +'<td class="mono" style="font-size:11px">'+(c.track||'‚Äî')+'</td>'

      +'<td style="font-size:11px;color:var(--ora)">'+c.stage+'</td>'

      +'<td class="inline-edit-cell"><span class="inline-status" onclick="openStatusDropdown(event,\'citizenship\','+i+',\''+c.status+'\',CIT_STATUSES,\'/citizenship\',\'num\')" title="'+_t('inline_status_tip')+'">'+bdg(c.status)+'</span></td>'

      +'<td class="inline-edit-cell"><span class="inline-date" onclick="openDatePopup(event,\'citizenship\','+i+',\''+(c.updated||'')+'\',\'/citizenship\',\'num\')" title="'+_t('inline_date_tip')+'">'+(c.updated||'‚Äî')+'</span></td>'

      +'<td style="font-size:11px;color:var(--t2)">'+(c.comment||'‚Äî')+'</td>'

      +'<td style="white-space:nowrap">'

        +'<button class="edit-btn" onclick="editCitizenship('+i+',event)">‚úè</button>'

        +'<button class="del-btn" data-mod="citizenship" data-idx="'+i+'" data-lbl="'+encodeURIComponent(c.num+' '+c.name)+'" onclick="handleDelBtn(this,event)">üóë</button>'

      +'</td>'

      +'</tr>';

  }).join(''):'<tr><td colspan="10" style="padding:24px;text-align:center;color:var(--t3);font-size:11px">'+_t('no_data_cit')+'</td></tr>';

}

function editCitizenship(idx,e){

  e&&e.stopPropagation();

  const c=idx<0?{num:'',name:'',type:'',date:'',track:'',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:''}:citizenship[idx];

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">${idx<0?'–î–æ–±–∞–≤–∏—Ç—å':'–ò–∑–º–µ–Ω–∏—Ç—å'} ‚Äî –ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">‚Ññ –∫–ª–∏–µ–Ω—Ç–∞</label><input class="mi" id="ci-num" value="${c.num}"></div>

      <div class="mf"><label class="mfl">–§–ò–û</label><input class="mi" id="ci-name" value="${c.name}"></div>

      <div class="mf"><label class="mfl">–¢–∏–ø</label><input class="mi" id="ci-type" value="${c.type}" placeholder="–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è, –ï–°..."></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏</label><input class="mi" id="ci-date" value="${c.date}" placeholder="DD/MM/YYYY"></div>

      <div class="mf"><label class="mfl">–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä</label><input class="mi" id="ci-track" value="${c.track||''}"></div>

    </div>

    <div class="mrow">

      <div class="mf">

        <label class="mfl">–≠—Ç–∞–ø</label>

        <select class="ms" id="ci-stage">${CIT_STAGES.map(s=>`<option ${c.stage===s?'selected':''}>${s}</option>`).join('')}</select>

      </div>

      <div class="mf">

        <label class="mfl">–°—Ç–∞—Ç—É—Å <span style="color:var(--gre);font-size:8px">‚Üê –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è</span></label>

        <input class="mi" id="ci-status" value="${c.status}">

      </div>

    </div>

    <div class="msec"><label class="mfl">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea class="mta" id="ci-comment">${c.comment}</textarea></div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="saveCitizenship(${idx})">${idx<0?'–î–æ–±–∞–≤–∏—Ç—å':'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</button>

    </div>`);

}

async function saveCitizenship(idx){

  const obj={num:g('ci-num').value,name:g('ci-name').value,type:g('ci-type').value,date:g('ci-date').value,track:g('ci-track').value,stage:g('ci-stage').value,status:g('ci-status').value,updated:nowDMY(),comment:g('ci-comment').value};

  if(idx<0)citizenship.push(obj);else citizenship[idx]=obj;

  closeModal();renderCitizenship();renderDash();toast(idx<0?'–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úì':'–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚úì');

  await (idx<0?apiPost('/citizenship',obj):apiPut('/citizenship/'+obj.num,obj));

}

// ============================================================

// RIGHTS

// ============================================================

function renderRights(){

  g('rights-tbody').innerHTML=rights.length?rights.map((r,i)=>{

    return '<tr>'

      +'<td class="mono" style="color:var(--gre)">'+r.num+'</td>'

      +'<td style="font-weight:600">'+r.name+'</td>'

      +'<td><span class="bdg gre">'+(r.country||'‚Äî')+'</span></td>'

      +'<td class="mono" style="font-size:11px">'+(r.date||'‚Äî')+'</td>'

      +'<td style="font-size:11px;color:var(--gre)">'+r.stage+'</td>'

      +'<td class="inline-edit-cell"><span class="inline-status" onclick="openStatusDropdown(event,\'rights\','+i+',\''+r.status+'\',RIGHTS_STATUSES,\'/rights\',\'num\')" title="'+_t('inline_status_tip')+'">'+bdg(r.status)+'</span></td>'

      +'<td class="inline-edit-cell"><span class="inline-date" onclick="openDatePopup(event,\'rights\','+i+',\''+(r.updated||'')+'\',\'/rights\',\'num\')" title="'+_t('inline_date_tip')+'">'+(r.updated||'‚Äî')+'</span></td>'

      +'<td style="font-size:11px;color:var(--t2)">'+(r.comment||'‚Äî')+'</td>'

      +'<td style="white-space:nowrap">'

        +'<button class="edit-btn" onclick="editRights('+i+',event)">‚úè</button>'

        +'<button class="del-btn" data-mod="rights" data-idx="'+i+'" data-lbl="'+encodeURIComponent(r.num+' '+r.name)+'" onclick="handleDelBtn(this,event)">üóë</button>'

      +'</td>'

      +'</tr>';

  }).join(''):'<tr><td colspan="9" style="padding:24px;text-align:center;color:var(--t3);font-size:11px">'+_t('no_data_rights')+'</td></tr>';

}

function editRights(idx,e){

  e&&e.stopPropagation();

  const r=idx<0?{num:'',name:'',country:'',date:'',stage:'–î–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏–Ω—è—Ç—ã',status:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',updated:'',comment:''}:rights[idx];

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">${idx<0?'–î–æ–±–∞–≤–∏—Ç—å':'–ò–∑–º–µ–Ω–∏—Ç—å'} ‚Äî –ü—Ä–∞–≤–∞</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">‚Ññ –∫–ª–∏–µ–Ω—Ç–∞</label><input class="mi" id="ri-num" value="${r.num}"></div>

      <div class="mf"><label class="mfl">–§–ò–û</label><input class="mi" id="ri-name" value="${r.name}"></div>

      <div class="mf"><label class="mfl">–°—Ç—Ä–∞–Ω–∞ –ø—Ä–∞–≤</label><input class="mi" id="ri-country" value="${r.country||''}"></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏</label><input class="mi" id="ri-date" value="${r.date}" placeholder="DD/MM/YYYY"></div>

      <div class="mf">

        <label class="mfl">–≠—Ç–∞–ø</label>

        <select class="ms" id="ri-stage">${RIGHTS_STAGES.map(s=>`<option ${r.stage===s?'selected':''}>${s}</option>`).join('')}</select>

      </div>

      <div class="mf">

        <label class="mfl">–°—Ç–∞—Ç—É—Å <span style="color:var(--gre);font-size:8px">‚Üê –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è</span></label>

        <input class="mi" id="ri-status" value="${r.status}">

      </div>

    </div>

    <div class="msec"><label class="mfl">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea class="mta" id="ri-comment">${r.comment}</textarea></div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="saveRights(${idx})">${idx<0?'–î–æ–±–∞–≤–∏—Ç—å':'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</button>

    </div>`,'narrow');

}

async function saveRights(idx){

  const obj={num:g('ri-num').value,name:g('ri-name').value,country:g('ri-country').value,date:g('ri-date').value,stage:g('ri-stage').value,status:g('ri-status').value,updated:nowDMY(),comment:g('ri-comment').value};

  if(idx<0)rights.push(obj);else rights[idx]=obj;

  closeModal();renderRights();renderDash();toast(idx<0?'–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úì':'–ü—Ä–∞–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚úì');

  await (idx<0?apiPost('/rights',obj):apiPut('/rights/'+obj.num,obj));

}

// ============================================================

// TASKS ‚Äî DRAG & DROP

// ============================================================

let taskClientFilter='';

let _dragId=null;

function filterTasksByClient(v){taskClientFilter=v;renderTasks();}

function renderTasks(){

  const COLS=[{key:'todo',label:'–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é',color:'var(--acc)'},{key:'inprogress',label:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ',color:'var(--yel)'},{key:'done',label:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ',color:'var(--gre)'}];

  const visibleTasks=getVisibleTasks();

  const data=taskClientFilter?visibleTasks.filter(t=>t.client.includes(taskClientFilter)):visibleTasks;

  g('task-board').innerHTML=COLS.map(col=>{

    const ct=data.filter(t=>t.stage===col.key);

    return`<div class="tcol" id="tcol-${col.key}" ondragover="tDragOver(event,'${col.key}')" ondrop="tDrop(event,'${col.key}')" ondragleave="tDragLeave(event)">

      <div class="tcol-h">

        <div style="width:7px;height:7px;border-radius:50%;background:${col.color};flex-shrink:0"></div>

        <div class="tcol-t" style="color:${col.color}">${col.label}</div>

        <div class="tcol-cnt">${ct.length}</div>

      </div>

      <div class="tlist" id="tlist-${col.key}">

        ${ct.map(t=>renderTCard(t)).join('')}

      </div>

      <div class="t-add" onclick="openAddTaskModal('${col.key}')">+ –∑–∞–¥–∞—á–∞</div>

    </div>`;

  }).join('');

}

function renderTCard(t){

  const now=new Date();const ov=t.stage!=='done'&&t.due&&new Date(t.due)<now;

  return`<div class="tcard pb-${t.prio}" id="tc-${t.id}" draggable="true" ondragstart="tDragStart(event,'${t.id}')" onclick="openTaskModal('${t.id}')">

    <div class="tcard-txt">${t.text}</div>

    <div class="tcard-meta">

      ${t.client?`<span class="cn">–∫–ª.${t.client}</span>`:''}

      ${t.assignee&&t.assignee!=='‚Äî'?`<span class="as">${t.assignee}</span>`:''}

      <span class="pdot ${t.prio}"></span>

      ${t.due?`<span style="color:${ov?'var(--red)':'var(--t3)'}">${t.due}</span>`:''}

      ${t.cmts&&t.cmts.length>0?`<span>üí¨${t.cmts.length}</span>`:''}

    </div>

    <div class="tcard-acts" onclick="event.stopPropagation()">

      ${t.stage!=='todo'?`<button class="btn btn-g btn-xs" onclick="moveTask('${t.id}','todo',event)">‚Üê Todo</button>`:''}

      ${t.stage!=='inprogress'?`<button class="btn btn-g btn-xs" onclick="moveTask('${t.id}','inprogress',event)">‚Üí –ü—Ä–æ—Ü–µ—Å—Å</button>`:''}

      ${t.stage!=='done'?`<button class="btn btn-p btn-xs" onclick="moveTask('${t.id}','done',event)">‚úì</button>`:''}

    </div>

  </div>`;

}

function tDragStart(e,id){_dragId=id;setTimeout(()=>{const el=g('tc-'+id);if(el)el.classList.add('dragging');},0);}

function tDragOver(e,col){e.preventDefault();e.currentTarget.classList.add('drop-active');}

function tDragLeave(e){e.currentTarget.classList.remove('drop-active');}

function tDrop(e,col){

  e.preventDefault();e.currentTarget.classList.remove('drop-active');

  if(_dragId){const t=tasks.find(x=>x.id===_dragId);if(t)t.stage=col;_dragId=null;renderTasks();renderTaskStats();}

}

function moveTask(id,stage,e){if(e)e.stopPropagation();const t=tasks.find(x=>x.id===id);if(t)t.stage=stage;renderTasks();renderTaskStats();}

document.addEventListener('dragend',()=>{document.querySelectorAll('.tcard').forEach(c=>c.classList.remove('dragging'));document.querySelectorAll('.tcol').forEach(c=>c.classList.remove('drop-active'));});

function openTaskModal(id){

  const t=tasks.find(x=>x.id===id);if(!t)return;

  openModal(`

    <div class="mhdr">

      <div>

        <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t3)">–ó–∞–¥–∞—á–∞${t.client?' ¬∑ –∫–ª–∏–µ–Ω—Ç '+t.client:''}</div>

        <div style="font-family:'Unbounded',sans-serif;font-size:15px;font-weight:700;margin-top:3px">${t.text}</div>

      </div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–≠—Ç–∞–ø</label>

        <select class="ms" id="tm-stage"><option value="todo" ${t.stage==='todo'?'selected':''}>–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option><option value="inprogress" ${t.stage==='inprogress'?'selected':''}>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option><option value="done" ${t.stage==='done'?'selected':''}>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option></select>

      </div>

      <div class="mf"><label class="mfl">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>

        <select class="ms" id="tm-prio"><option value="high" ${t.prio==='high'?'selected':''}>üî¥ –í—ã—Å–æ–∫–∏–π</option><option value="mid" ${t.prio==='mid'?'selected':''}>üü° –°—Ä–µ–¥–Ω–∏–π</option><option value="low" ${t.prio==='low'?'selected':''}>‚ö™ –ù–∏–∑–∫–∏–π</option></select>

      </div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>

        <select class="ms" id="tm-assignee">${TEAM.map(a=>`<option ${t.assignee===a?'selected':''}>${a}</option>`).join('')}</select>

      </div>

      <div class="mf"><label class="mfl">–°—Ä–æ–∫</label><input class="mi" type="date" id="tm-due" value="${t.due}"></div>

      <div class="mf"><label class="mfl">–ö–ª–∏–µ–Ω—Ç ‚Ññ</label><input class="mi" id="tm-client" value="${t.client}"></div>

    </div>

    <hr class="mdiv">

    <div class="msec">

      <div class="msl">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${(t.cmts||[]).length})</div>

      <div class="cmt-list" id="tm-cmtlist">

        ${(t.cmts||[]).map(c=>`<div class="cmt"><div class="cmt-m"><span>${c.a}</span> ¬∑ ${c.d}</div><div class="cmt-t">${c.t}</div></div>`).join('')}

        ${!(t.cmts||[]).length?'<div style="font-size:10px;color:var(--t3);padding:4px">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>':''}

      </div>

      <textarea class="mta" id="tm-new-cmt" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="min-height:52px;margin-bottom:5px"></textarea>

      <button class="btn btn-g btn-sm" onclick="addComment('${t.id}')">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>

    </div>

    <div class="mft">

      <button class="btn btn-red btn-sm" style="margin-right:auto" onclick="deleteTask('${t.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="saveTask('${t.id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

    </div>`,'wide');

}

function addComment(tid){

  const t=tasks.find(x=>x.id===tid);const txt=(g('tm-new-cmt').value||'').trim();

  if(!t||!txt)return;

  if(!t.cmts)t.cmts=[];

  t.cmts.push({a:'–ú–µ–Ω–µ–¥–∂–µ—Ä',d:nowDMY(),t:txt});

  const el=g('tm-cmtlist');

  if(el)el.innerHTML=t.cmts.map(c=>`<div class="cmt"><div class="cmt-m"><span>${c.a}</span> ¬∑ ${c.d}</div><div class="cmt-t">${c.t}</div></div>`).join('');

  g('tm-new-cmt').value='';

}

function saveTask(tid){

  const t=tasks.find(x=>x.id===tid);if(!t)return;

  t.stage=g('tm-stage').value;t.prio=g('tm-prio').value;t.assignee=g('tm-assignee').value;t.due=g('tm-due').value;t.client=g('tm-client').value;

  closeModal();renderTasks();renderTaskStats();

}

function deleteTask(tid){if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')){tasks=tasks.filter(x=>x.id!==tid);closeModal();renderTasks();renderTaskStats();}}

function openAddTaskModal(defaultStage='todo',defaultClient=''){

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="msec"><label class="mfl">–û–ø–∏—Å–∞–Ω–∏–µ *</label><textarea class="mta" id="nt-text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."></textarea></div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–ö–ª–∏–µ–Ω—Ç ‚Ññ</label><input class="mi" id="nt-client" value="${defaultClient}" placeholder="541"></div>

      <div class="mf"><label class="mfl">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label><select class="ms" id="nt-assignee">${TEAM.map(a=>`<option>${a}</option>`).join('')}</select></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label><select class="ms" id="nt-prio"><option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option><option value="mid" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option><option value="low">‚ö™ –ù–∏–∑–∫–∏–π</option></select></div>

      <div class="mf"><label class="mfl">–°—Ä–æ–∫</label><input class="mi" type="date" id="nt-due"></div>

      <div class="mf"><label class="mfl">–≠—Ç–∞–ø</label><select class="ms" id="nt-stage"><option value="todo" ${defaultStage==='todo'?'selected':''}>–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option><option value="inprogress" ${defaultStage==='inprogress'?'selected':''}>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option><option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option></select></div>

    </div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="createTask()">–°–æ–∑–¥–∞—Ç—å</button>

    </div>`,'narrow');

}

function createTask(){

  const txt=(g('nt-text').value||'').trim();if(!txt)return;

  tasks.unshift({id:uid(),text:txt,client:g('nt-client').value,assignee:g('nt-assignee').value,prio:g('nt-prio').value,stage:g('nt-stage').value,due:g('nt-due').value,created:today(),cmts:[]});

  closeModal();renderTasks();renderTaskStats();

}

// ============================================================

// SCHEDULE

// ============================================================

let schedY=2026,schedM=1,schedSel=null;

function schedMon(d){schedM+=d;if(schedM>11){schedM=0;schedY++;}if(schedM<0){schedM=11;schedY--;}renderSchedMini();}

function renderSchedMini(){

  g('sched-m-title').textContent=`${MONTHS[schedM]} ${schedY}`;

  const fd=new Date(schedY,schedM,1).getDay(),dim=new Date(schedY,schedM+1,0).getDate(),prev=new Date(schedY,schedM,0).getDate(),so=(fd+6)%7;

  const today_=new Date(),mDates=new Set(meetings.map(m=>m.date));

  const dows=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];

  let h=dows.map(d=>`<div class="sched-dow">${d}</div>`).join('');

  for(let i=so-1;i>=0;i--)h+=`<div class="sched-day oth">${prev-i}</div>`;

  for(let d=1;d<=dim;d++){

    const ds=`${String(d).padStart(2,'0')}.${String(schedM+1).padStart(2,'0')}.${schedY}`;

    const isT=today_.getFullYear()===schedY&&today_.getMonth()===schedM&&today_.getDate()===d;

    h+=`<div class="sched-day ${mDates.has(ds)?'has':''} ${isT?'tod':''} ${schedSel===ds?'sel':''}" onclick="selectSchedDay('${ds}')">${d}</div>`;

  }

  const rem=(so+dim)%7;if(rem>0)for(let d=1;d<=7-rem;d++)h+=`<div class="sched-day oth">${d}</div>`;

  g('sched-mg').innerHTML=h;

}

function selectSchedDay(ds){

  schedSel=ds;renderSchedMini();

  g('sched-sel-d').textContent=ds;

  const dm=meetings.filter(m=>m.date===ds);const occ=new Set(dm.map(m=>m.time));

  g('sched-sl').innerHTML=SLOTS.map(slot=>{

    const isFree=!occ.has(slot);

    const occName=!isFree?(dm.find(m=>m.time===slot)?.name||'–∑–∞–Ω—è—Ç'):'';

    const onclickAttr=isFree?`onclick="openBookSlotModal('${ds}','${slot}')"`:''

    return `<div class="slot-item ${isFree?'free':'occ'}" ${onclickAttr} title="${isFree?'–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è':occName}">

      <div class="slot-dot ${isFree?'free':'occ'}"></div>

      <span>${slot}</span>

      <span style="margin-left:auto;font-size:8.5px">${isFree?'—Å–≤–æ–±–æ–¥–Ω–æ':occName}</span>

    </div>`;

  }).join('');

  renderMeetings(meetings.filter(m=>m.date===ds));

}

function filterMeetings(f,el){

  document.querySelectorAll('#sched-status-chips .chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');

  renderMeetings(f==='all'?meetings:meetings.filter(m=>m.status===f));

}

function renderMeetings(data){

  g('sched-tbody').innerHTML=(data||meetings).sort((a,b)=>parseDMY(a.date)-parseDMY(b.date)).map(m=>`

    <tr>

      <td class="mono" style="color:var(--acc)">${m.date} ¬∑ ${m.time}</td>

      <td style="font-weight:600">${m.name}</td>

      <td class="mono" style="color:var(--acc);font-size:10.5px">${m.tg||'‚Äî'}</td>

      <td>${m.status==='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ'?`<span class="bdg gre">‚úì –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>`:`<span class="bdg yel">‚è≥ ${m.status||'‚Äî'}</span>`}</td>

      <td>${m.meet&&m.meet!=='pending'&&m.meet.startsWith('http')?`<a class="meet-lnk" href="${m.meet}" target="_blank">‚Üó Meet</a>`:m.meet?`<span style="font-size:9px;color:var(--t3)">${m.meet}</span>`:'‚Äî'}</td>

    </tr>`).join('');

}

function openBookSlotModal(date='',time=''){

  openModal(`

    <div class="mhdr">

      <div style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700">–ó–∞–Ω—è—Ç—å —Å–ª–æ—Ç</div>

      <button class="mcls" onclick="closeModal()">‚úï</button>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–î–∞—Ç–∞ (–î–î.–ú–ú.–ì–ì–ì–ì)</label><input class="mi" id="bs-date" value="${date}" placeholder="18.02.2026"></div>

      <div class="mf"><label class="mfl">–í—Ä–µ–º—è</label><select class="ms" id="bs-time">${SLOTS.map(s=>`<option ${s===time?'selected':''}>${s}</option>`).join('')}</select></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ *</label><input class="mi" id="bs-name"></div>

      <div class="mf"><label class="mfl">Telegram</label><input class="mi" id="bs-tg" placeholder="@username"></div>

    </div>

    <div class="mrow">

      <div class="mf"><label class="mfl">–°—Ç–∞—Ç—É—Å</label><select class="ms" id="bs-status"><option>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option><option>–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</option></select></div>

      <div class="mf"><label class="mfl">Google Meet (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label><input class="mi" id="bs-meet" placeholder="https://meet.google.com/..."></div>

    </div>

    <div class="mft">

      <button class="btn btn-g" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

      <button class="btn btn-p" onclick="bookSlot()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

    </div>`);

}

async function bookSlot(){

  const name=(g('bs-name').value||'').trim();if(!name)return;

  const obj={date:g('bs-date').value,time:g('bs-time').value,name,tg:g('bs-tg').value,status:g('bs-status').value,meet:g('bs-meet').value};

  meetings.push(obj);

  closeModal();renderMeetings(meetings);renderSchedMini();if(schedSel)selectSchedDay(schedSel);renderDash();

  await apiPost('/schedule',obj);

}

// ============================================================

// CALENDAR

// ============================================================

let calY=2026,calM=1,calSel=null;

function calMon(d){calM+=d;if(calM>11){calM=0;calY++;}if(calM<0){calM=11;calY--;}renderCal();}

function renderCal(){

  g('cal-month').textContent=`${MONTHS[calM]} ${calY}`;

  const fd=new Date(calY,calM,1).getDay(),dim=new Date(calY,calM+1,0).getDate(),prev=new Date(calY,calM,0).getDate(),so=(fd+6)%7;

  const today_=new Date();let cells='';

  for(let i=so-1;i>=0;i--)cells+=`<div class="cal-cell om"><div class="cal-dn">${prev-i}</div></div>`;

  for(let d=1;d<=dim;d++){

    const ds=`${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    const isT=today_.getFullYear()===calY&&today_.getMonth()===calM&&today_.getDate()===d;

    const isSel=calSel===ds;const evts=CAL_EVENTS[ds]||[];

    cells+=`<div class="cal-cell ${isT?'today':''} ${isSel?'selected':''}" onclick="selectCalDay('${ds}')"><div class="cal-dn">${d}</div>${evts.slice(0,2).map(e=>`<div class="cal-ev ${e.type}">${e.label}</div>`).join('')}${evts.length>2?`<div style="font-size:7px;color:var(--t3);padding:0 3px">+${evts.length-2}</div>`:''}</div>`;

  }

  const rem=7-((so+dim)%7);if(rem<7)for(let d=1;d<=rem;d++)cells+=`<div class="cal-cell om"><div class="cal-dn">${d}</div></div>`;

  g('cal-grid').innerHTML=cells;

}

function selectCalDay(ds){

  calSel=ds;renderCal();

  const[y,m,d]=ds.split('-');g('cal-sel-d').textContent=`${d}.${m}.${y}`;

  const evts=CAL_EVENTS[ds]||[];

  g('cal-sb-evts').innerHTML=evts.length?evts.map(e=>`<div class="cal-evitem"><div class="cal-evtime">${e.time||'–í–µ—Å—å –¥–µ–Ω—å'}</div><div class="cal-evname">${e.detail.split('¬∑')[0].trim()}</div><div class="cal-evmeta">${(e.detail.split('¬∑')[1]||'').trim()}</div></div>`).join(''):'<div class="cal-empty">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>';

}

// ============================================================

// MODAL

// ============================================================

function openModal(html,size=''){

  const box=g('modal-box');

  box.className='modal'+(size?' '+size:'');

  g('modal-in').innerHTML=html;

  g('modal-ov').classList.add('open');

}

function closeModal(){g('modal-ov').classList.remove('open');}

function toast(msg,type='ok'){

  const t=document.createElement('div');

  t.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:'+(type==='ok'?'#16a34a':'#dc2626')+';color:#fff;padding:9px 20px;border-radius:20px;font-size:12px;font-weight:600;z-index:9999;box-shadow:0 4px 14px rgba(0,0,0,.2);font-family:Manrope,sans-serif;white-space:nowrap;pointer-events:none';

  t.textContent=msg;document.body.appendChild(t);

  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300)},2500);

}

function closeOv(e){if(e.target===g('modal-ov'))closeModal();}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

// ============================================================

// RENDER ALL

// ============================================================

function renderAll(){

  renderDash();

  renderClients();

  renderKanban();

  renderAIMA();

  renderVisaD();

  renderCourts();

  renderCitizenship();

  renderRights();

  renderMeetings(meetings);

  renderSchedMini();

  renderTasks();

  renderTaskStats();

}

// ============================================================

// INIT

// ============================================================

(function init(){

  initKbChips();

  renderAll();

  renderCal();

  renderSchedMini();

  g('api-status-txt').textContent='–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ¬∑ –Ω–∞–∂–º–∏—Ç–µ ‚Üª –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏';

  g('api-dot').className='api-dot warn';

  updateIntStatus(false);

  // Restore saved language

  if(_lang !== 'ru'){

    document.querySelectorAll('.lang-btn').forEach(b=>{

      b.classList.toggle('active', b.textContent.trim().toLowerCase()===_lang);

    });

    _applyI18n();

  }

  initAuth();

})();

</script>

<!-- AUTH SCREEN -->

<div class="auth-overlay" id="auth-overlay">

  <div class="auth-box">

    <div class="auth-logo">üáµüáπ</div>

    <div class="auth-title">MigrAll CRM</div>

    <div class="auth-sub">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>

    <div class="auth-field">

      <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>

      <input id="auth-user" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" autocomplete="username" onkeydown="if(event.key==='Enter')g('auth-pass').focus()">

    </div>

    <div class="auth-field">

      <label>–ü–∞—Ä–æ–ª—å</label>

      <input id="auth-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">

    </div>

    <button class="auth-btn" onclick="doLogin()">–í–æ–π—Ç–∏ ‚Üí</button>

    <div class="auth-err" id="auth-err">–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å</div>

    <div style="margin-top:20px;font-size:11px;color:var(--t3)">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥:</div>

    <div class="auth-users" id="auth-quick"></div>

  </div>

</div>

</body>

</html>



